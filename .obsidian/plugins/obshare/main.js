/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => FeishuUploaderPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian2 = require("obsidian");

// feishu-api.ts
var import_obsidian = require("obsidian");
var FeishuApiClient = class {
  // 每次删除请求间隔350ms，确保不超过每秒3次
  constructor(appId, appSecret, app, apiCallCountCallback) {
    this.accessToken = null;
    this.tokenExpireTime = 0;
    this.tokenRefreshPromise = null;
    // 防止并发token获取
    // 飞书API基础URL
    this.baseUrl = "https://open.feishu.cn/open-apis";
    // 限速相关属性
    this.deleteRequestQueue = [];
    this.isProcessingDeleteQueue = false;
    this.lastDeleteRequestTime = 0;
    this.DELETE_REQUEST_INTERVAL = 350;
    this.appId = appId;
    this.appSecret = appSecret;
    this.app = app;
    this.apiCallCountCallback = apiCallCountCallback;
  }
  /**
   * 处理删除请求队列，确保不超过频率限制
   */
  async processDeleteQueue() {
    if (this.isProcessingDeleteQueue || this.deleteRequestQueue.length === 0) {
      return;
    }
    this.isProcessingDeleteQueue = true;
    while (this.deleteRequestQueue.length > 0) {
      const now = Date.now();
      const timeSinceLastRequest = now - this.lastDeleteRequestTime;
      if (timeSinceLastRequest < this.DELETE_REQUEST_INTERVAL) {
        const waitTime = this.DELETE_REQUEST_INTERVAL - timeSinceLastRequest;
        await new Promise((resolve) => setTimeout(resolve, waitTime));
      }
      const request = this.deleteRequestQueue.shift();
      if (request) {
        this.lastDeleteRequestTime = Date.now();
        try {
          await request();
        } catch (error) {
          console.error("[\u98DE\u4E66API] \u5220\u9664\u8BF7\u6C42\u6267\u884C\u5931\u8D25:", error);
          throw error;
        }
      }
    }
    this.isProcessingDeleteQueue = false;
  }
  /**
   * 将删除请求添加到队列中
   */
  async queueDeleteRequest(request) {
    return new Promise((resolve, reject) => {
      const wrappedRequest = async () => {
        try {
          const result = await request();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      };
      this.deleteRequestQueue.push(wrappedRequest);
      this.processDeleteQueue().catch(reject);
    });
  }
  /**
   * 获取访问令牌
   */
  async getAccessToken() {
    const now = Date.now();
    if (this.accessToken && now < this.tokenExpireTime - 30 * 60 * 1e3) {
      console.log("[\u98DE\u4E66API] \u4F7F\u7528\u7F13\u5B58\u7684\u8BBF\u95EE\u4EE4\u724C\uFF0C\u5269\u4F59\u6709\u6548\u65F6\u95F4:", Math.round((this.tokenExpireTime - now) / 6e4), "\u5206\u949F");
      return this.accessToken;
    }
    if (this.tokenRefreshPromise) {
      console.log("[\u98DE\u4E66API] \u7B49\u5F85\u6B63\u5728\u8FDB\u884C\u7684token\u5237\u65B0\u8BF7\u6C42...");
      return await this.tokenRefreshPromise;
    }
    console.log("[\u98DE\u4E66API] \u5F00\u59CB\u83B7\u53D6\u65B0\u7684\u8BBF\u95EE\u4EE4\u724C");
    this.tokenRefreshPromise = this.performTokenRefresh();
    try {
      const token = await this.tokenRefreshPromise;
      return token;
    } finally {
      this.tokenRefreshPromise = null;
    }
  }
  /**
   * 执行实际的token刷新操作
   */
  async performTokenRefresh() {
    var _a, _b, _c;
    const now = Date.now();
    const url = `${this.baseUrl}/auth/v3/tenant_access_token/internal`;
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8"
      },
      body: JSON.stringify({
        app_id: this.appId,
        app_secret: this.appSecret
      })
    };
    console.log("[\u98DE\u4E66API] \u8BF7\u6C42\u53C2\u6570:", {
      url: requestParam.url,
      method: requestParam.method,
      headers: requestParam.headers,
      appId: this.appId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      appSecret: this.appSecret ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E"
    });
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      console.log("[\u98DE\u4E66API] \u{1F680} \u8C03\u7528getAccessToken API");
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      console.log("[\u98DE\u4E66API] \u6536\u5230\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers
      });
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u54CD\u5E94\u5185\u5BB9:", {
        code: result.code,
        msg: result.msg,
        hasTenantAccessToken: !!result.tenant_access_token,
        fullResponse: result
      });
      if (!result.tenant_access_token) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11tenant_access_token\u5B57\u6BB5\uFF0C\u5B8C\u6574\u54CD\u5E94:", JSON.stringify(result, null, 2));
        throw new Error(`API\u54CD\u5E94\u683C\u5F0F\u9519\u8BEF: \u7F3A\u5C11tenant_access_token\u5B57\u6BB5`);
      }
      if (result.code !== 0) {
        throw new Error(`\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25: ${result.msg}`);
      }
      this.accessToken = result.tenant_access_token;
      this.tokenExpireTime = now + result.expire * 1e3;
      console.log("[\u98DE\u4E66API] \u8BBF\u95EE\u4EE4\u724C\u83B7\u53D6\u6210\u529F:", {
        tokenLength: ((_b = this.accessToken) == null ? void 0 : _b.length) || 0,
        tokenPrefix: ((_c = this.accessToken) == null ? void 0 : _c.substring(0, 20)) + "...",
        expireSeconds: result.expire,
        expireTime: new Date(this.tokenExpireTime).toISOString(),
        currentTime: new Date(now).toISOString(),
        timeUntilExpire: this.tokenExpireTime - now
      });
      return this.accessToken;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25:", error);
      if (error instanceof TypeError && error.message.includes("Failed to fetch")) {
        console.error("[\u98DE\u4E66API] \u7F51\u7EDC\u8FDE\u63A5\u9519\u8BEF\uFF0C\u53EF\u80FD\u539F\u56E0:");
        console.error("1. \u7F51\u7EDC\u8FDE\u63A5\u4E0D\u7A33\u5B9A\u6216\u65AD\u5F00");
        console.error("2. \u9632\u706B\u5899\u6216\u4EE3\u7406\u963B\u6B62\u4E86\u8BF7\u6C42");
        console.error("3. \u98DE\u4E66API\u670D\u52A1\u6682\u65F6\u4E0D\u53EF\u7528");
        console.error("4. DNS\u89E3\u6790\u95EE\u9898");
        throw new Error("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5");
      }
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 上传文件到飞书云空间
   * 使用 drive/v1/files/upload_all 接口将文件上传到飞书云空间
   * @param fileName 文件名（需包含扩展名）
   * @param fileContent 文件内容（base64编码）
   * @param folderToken 目标文件夹token（可选）
   * @returns 返回上传后的文件token
   */
  async uploadFile(fileName, fileContent, folderToken) {
    var _a, _b;
    const token = await this.getAccessToken();
    const url = `https://open.feishu.cn/open-apis/drive/v1/files/upload_all`;
    const binaryData = Uint8Array.from(atob(fileContent), (c) => c.charCodeAt(0));
    const boundary = "feishu-file-boundary-" + Math.random().toString(36).substring(2, 15);
    const encoder = new TextEncoder();
    const parts = [];
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file_name"\r
\r
`));
    parts.push(encoder.encode(`${fileName}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_type"\r
\r
`));
    parts.push(encoder.encode(`explorer\r
`));
    if (folderToken) {
      parts.push(encoder.encode(`--${boundary}\r
`));
      parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_node"\r
\r
`));
      parts.push(encoder.encode(`${folderToken}\r
`));
    }
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="size"\r
\r
`));
    parts.push(encoder.encode(`${binaryData.length.toString()}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    const fileNameWithoutExt = fileName.replace(/\.[^/.]+$/, "");
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file"; filename="${fileNameWithoutExt}"\r
`));
    parts.push(encoder.encode(`Content-Type: application/octet-stream\r
\r
`));
    parts.push(binaryData);
    parts.push(encoder.encode(`\r
`));
    parts.push(encoder.encode(`--${boundary}--\r
`));
    const totalLength = parts.reduce((sum, part) => sum + part.length, 0);
    const body = new Uint8Array(totalLength);
    let offset = 0;
    for (const part of parts) {
      body.set(part, offset);
      offset += part.length;
    }
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": `multipart/form-data; boundary=${boundary}`
      },
      body: body.buffer
    };
    console.log("[\u98DE\u4E66API] \u5F00\u59CB\u4E0A\u4F20\u6587\u4EF6:", {
      fileName,
      folderToken,
      url,
      hasToken: !!token,
      tokenPrefix: token ? token.substring(0, 10) + "..." : "none",
      bodySize: body.length,
      boundary
    });
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      console.log("[\u98DE\u4E66API] \u{1F680} \u8C03\u7528uploadFile API");
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u6587\u4EF6\u4E0A\u4F20\u54CD\u5E94:", {
        status: response.status,
        code: result.code,
        msg: result.msg,
        hasData: !!result.data,
        fileToken: (_b = result.data) == null ? void 0 : _b.file_token
      });
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u4E0A\u4F20\u6587\u4EF6\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      if (!result.data || !result.data.file_token) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11file_token:", result);
        throw new Error("\u4E0A\u4F20\u6210\u529F\u4F46\u672A\u8FD4\u56DEfile_token");
      }
      console.log("[\u98DE\u4E66API] \u6587\u4EF6\u4E0A\u4F20\u6210\u529F\uFF0Cfile_token:", result.data.file_token);
      return result.data.file_token;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u4E0A\u4F20\u6587\u4EF6\u5230\u98DE\u4E66\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0,
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 上传图片素材到飞书云文档
   * 使用 drive/v1/medias/upload_all 接口将图片素材上传到指定云文档中
   * @param fileName 图片文件名（需包含扩展名）
   * @param fileContent 图片文件内容（base64编码）
   * @param documentId 目标飞书文档的document_id
   * @param blockId 目标图片块的block_id
   * @returns 返回上传后的文件token
   */
  async uploadImageMaterial(fileName, fileContent, documentId, blockId) {
    var _a;
    console.log("[\u98DE\u4E66API] \u{1F680} \u8C03\u7528uploadImageMaterial API");
    const token = await this.getAccessToken();
    const url = `https://open.feishu.cn/open-apis/drive/v1/medias/upload_all`;
    const binaryData = Uint8Array.from(atob(fileContent), (c) => c.charCodeAt(0));
    const boundary = "feishu-image-boundary-" + Math.random().toString(36).substring(2, 15);
    const encoder = new TextEncoder();
    const parts = [];
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file_name"\r
\r
`));
    parts.push(encoder.encode(`${fileName}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_type"\r
\r
`));
    parts.push(encoder.encode(`docx_image\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_node"\r
\r
`));
    parts.push(encoder.encode(`${blockId}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="size"\r
\r
`));
    parts.push(encoder.encode(`${binaryData.length.toString()}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="extra"\r
\r
`));
    const extraData = JSON.stringify({ "drive_route_token": documentId });
    parts.push(encoder.encode(`${extraData}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file"; filename="${fileName}"\r
`));
    parts.push(encoder.encode(`Content-Type: application/octet-stream\r
\r
`));
    parts.push(binaryData);
    parts.push(encoder.encode(`\r
`));
    parts.push(encoder.encode(`--${boundary}--\r
`));
    const totalLength = parts.reduce((sum, part) => sum + part.length, 0);
    const body = new Uint8Array(totalLength);
    let offset = 0;
    for (const part of parts) {
      body.set(part, offset);
      offset += part.length;
    }
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": `multipart/form-data; boundary=${boundary}`
      },
      body: body.buffer
    };
    try {
      console.log("[\u98DE\u4E66API] \u5F00\u59CB\u4E0A\u4F20\u56FE\u7247\u7D20\u6750:", {
        fileName,
        documentId,
        url,
        hasToken: !!token,
        tokenPrefix: token ? token.substring(0, 10) + "..." : "null",
        boundary,
        bodySize: body.byteLength
      });
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      console.log("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        hasJson: !!response.json
      });
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u7ED3\u679C:", {
        code: result.code,
        msg: result.msg,
        hasData: !!result.data,
        fullResponse: result
      });
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      if (!result.data || !result.data.file_token) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11file_token:", result);
        throw new Error("\u4E0A\u4F20\u6210\u529F\u4F46\u672A\u8FD4\u56DEfile_token");
      }
      console.log("[\u98DE\u4E66API] \u56FE\u7247\u7D20\u6750\u4E0A\u4F20\u6210\u529F\uFF0Cfile_token:", result.data.file_token);
      return result.data.file_token;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5230\u98DE\u4E66\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0,
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 创建导入任务
   * @param fileName 文件名
   * @param fileToken 文件token（从上传文件接口获取）
   * @param folderToken 目标文件夹token（可选）
   */
  async createImportTask(fileName, fileToken, folderToken) {
    var _a, _b, _c;
    console.log("[\u98DE\u4E66API] \u{1F680} \u8C03\u7528createImportTask API");
    console.log("[\u98DE\u4E66API] \u5F00\u59CB\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1:", {
      fileName,
      fileToken: fileToken ? `${fileToken.substring(0, 10)}...` : "null",
      folderToken: folderToken ? `${folderToken.substring(0, 10)}...` : "null"
    });
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/drive/v1/import_tasks`;
    const lastDotIndex = fileName.lastIndexOf(".");
    let pureFileName;
    let fileExtension;
    if (lastDotIndex > 0 && fileName.substring(lastDotIndex + 1).toLowerCase() === "md") {
      pureFileName = fileName.substring(0, lastDotIndex);
      fileExtension = "md";
    } else {
      pureFileName = fileName;
      fileExtension = "md";
    }
    const requestBody = {
      file_extension: fileExtension,
      // Markdown文件扩展名
      file_name: pureFileName,
      // 纯文件名（不含扩展名）
      type: "docx",
      // 导入为飞书文档
      file_token: fileToken
    };
    if (folderToken) {
      requestBody.point = {
        mount_type: 1,
        // 1表示文件夹
        mount_key: folderToken
      };
    }
    console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u8BF7\u6C42\u53C2\u6570:", {
      url,
      requestBody: {
        ...requestBody,
        file_token: requestBody.file_token ? `${requestBody.file_token.substring(0, 10)}...` : "null"
      }
    });
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json; charset=utf-8"
      },
      body: JSON.stringify(requestBody)
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        hasData: !!response.json
      });
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u7ED3\u679C:", {
        code: result.code,
        msg: result.msg,
        hasData: !!result.data,
        ticket: ((_b = result.data) == null ? void 0 : _b.ticket) ? `${result.data.ticket.substring(0, 10)}...` : "null"
      });
      if (result.code === 0) {
        if (!((_c = result.data) == null ? void 0 : _c.ticket)) {
          console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u6210\u529F\u4F46\u7F3A\u5C11ticket");
          throw new Error("\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u6210\u529F\u4F46\u8FD4\u56DE\u6570\u636E\u4E2D\u7F3A\u5C11ticket");
        }
        console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u6210\u529F\uFF0C\u83B7\u5F97ticket:", {
          ticket: result.data.ticket ? `${result.data.ticket.substring(0, 10)}...` : "null"
        });
        return result.data.ticket;
      } else {
        console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25 (\u9519\u8BEF\u7801: ${result.code}): ${result.msg}`);
      }
    } catch (error) {
      if (error.status === 400 && error.json) {
        console.error("[\u98DE\u4E66API] HTTP 400\u9519\u8BEF\uFF0C\u8BE6\u7EC6\u54CD\u5E94:", {
          status: error.status,
          responseBody: error.json,
          headers: error.headers
        });
        const errorResult = error.json;
        if (errorResult.code && errorResult.msg) {
          throw new Error(`\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25 (\u9519\u8BEF\u7801: ${errorResult.code}): ${errorResult.msg}`);
        }
      }
      console.error("[\u98DE\u4E66API] \u521B\u5EFA\u98DE\u4E66\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0,
        requestUrl: url,
        hasToken: !!token,
        status: error.status || "unknown",
        responseBody: error.json || "no response body"
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 查询导入任务状态
   * @param ticket 任务票据
   */
  async queryImportTask(ticket) {
    var _a, _b;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/drive/v1/import_tasks/${ticket}`;
    console.log("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1:", {
      ticket,
      url,
      tokenValue: token,
      // 打印实际的token值
      hasToken: !!token
    });
    const requestParam = {
      url,
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json; charset=utf-8"
      }
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      console.log("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u54CD\u5E94 (\u539F\u59CB):", response.json);
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u54CD\u5E94:", {
        status: response.status,
        code: result.code,
        msg: result.msg,
        hasData: !!result.data,
        fullResponse: result
      });
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      const taskResult = ((_b = result.data) == null ? void 0 : _b.result) || result.data;
      console.log("[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1\u72B6\u6001:", {
        job_status: taskResult.job_status,
        job_error_msg: taskResult.job_error_msg,
        token: taskResult.token,
        url: taskResult.url,
        fullResult: taskResult,
        rawData: result.data
      });
      return taskResult;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5F02\u5E38:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0,
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 等待导入任务完成（支持递增重试间隔）
   * @param ticket 任务票据
   * @param onProgress 进度回调
   * @param maxRetries 最大重试次数（默认5次）
   */
  async waitForImportTask(ticket, onProgress, maxRetries = 5) {
    let retryCount = 0;
    while (retryCount <= maxRetries) {
      try {
        const result = await this.queryImportTask(ticket);
        console.log(`[\u98DE\u4E66API] \u{1F50D} \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u72B6\u6001 (\u7B2C${retryCount + 1}\u6B21):`, {
          ticket,
          job_status: result.job_status,
          job_status_meaning: result.job_status === 0 ? "\u6210\u529F" : result.job_status === 1 ? "\u8FDB\u884C\u4E2D" : result.job_status === 2 ? "\u5904\u7406\u4E2D" : "\u672A\u77E5",
          job_error_msg: result.job_error_msg,
          hasToken: !!result.token,
          hasUrl: !!result.url,
          fullResult: result
        });
        if (result.job_status === 0) {
          console.log(`[\u98DE\u4E66API] \u2705 \u5BFC\u5165\u4EFB\u52A1\u6210\u529F\u5B8C\u6210:`, {
            job_status: result.job_status,
            token: result.token,
            url: result.url,
            hasToken: !!result.token,
            hasUrl: !!result.url,
            fullResult: result
          });
          if (!result.token || !result.url) {
            console.error("[\u98DE\u4E66API] \u274C \u5BFC\u5165\u4EFB\u52A1\u5B8C\u6210\u4F46\u7F3A\u5C11\u5FC5\u8981\u4FE1\u606F:", result);
            throw new Error("\u5BFC\u5165\u4EFB\u52A1\u5B8C\u6210\u4F46\u672A\u8FD4\u56DE\u6587\u6863\u4FE1\u606F");
          }
          const formattedUrl = this.formatDocumentUrl(result.url, result.token);
          console.log(`[\u98DE\u4E66API] \u{1F4C4} \u683C\u5F0F\u5316\u540E\u7684\u6587\u6863URL:`, {
            originalUrl: result.url,
            formattedUrl,
            token: result.token
          });
          return {
            token: result.token,
            url: formattedUrl
          };
        } else if (result.job_status === 1 || result.job_status === 2) {
          retryCount++;
          console.log(`[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1${result.job_status === 1 ? "\u8FDB\u884C\u4E2D" : "\u5904\u7406\u4E2D"}\uFF0C\u7B2C${retryCount}\u6B21\u68C0\u67E5`);
          onProgress == null ? void 0 : onProgress("\u6587\u6863\u6B63\u5728\u5904\u7406\u4E2D\uFF0C\u8BF7\u7A0D\u5019...");
          if (retryCount > maxRetries) {
            console.error(`[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1\u5904\u7406\u8D85\u65F6\uFF0C\u5DF2\u91CD\u8BD5${maxRetries}\u6B21`);
            throw new Error("\u5BFC\u5165\u4EFB\u52A1\u5904\u7406\u8D85\u65F6\uFF0C\u8BF7\u7A0D\u540E\u624B\u52A8\u68C0\u67E5\u98DE\u4E66\u4E91\u6587\u6863");
          }
          let waitTime = 3e3;
          if (retryCount >= 3) {
            waitTime = 6e3;
          }
          console.log(`[\u98DE\u4E66API] \u7B49\u5F85${waitTime / 1e3}\u79D2\u540E\u8FDB\u884C\u7B2C${retryCount + 1}\u6B21\u91CD\u8BD5...`);
          await new Promise((resolve) => setTimeout(resolve, waitTime));
          continue;
        } else {
          console.error("[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1\u72B6\u6001\u672A\u77E5:", {
            job_status: result.job_status,
            job_error_msg: result.job_error_msg,
            fullResult: result
          });
          const errorMsg = result.job_error_msg || `\u672A\u77E5\u7684\u4EFB\u52A1\u72B6\u6001: ${result.job_status}`;
          throw new Error(`\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: ${errorMsg}`);
        }
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`[\u98DE\u4E66API] \u26A0\uFE0F waitForImportTask\u5F02\u5E38 (\u7B2C${retryCount + 1}\u6B21):`, {
          error: errorMessage,
          retryCount,
          maxRetries,
          willRetry: retryCount < maxRetries,
          fullError: error
        });
        if (errorMessage.includes("\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25") || errorMessage.includes("\u5BFC\u5165\u4EFB\u52A1\u5DF2\u63D0\u4EA4")) {
          console.error(`[\u98DE\u4E66API] \u{1F4A5} \u4EFB\u52A1\u72B6\u6001\u9519\u8BEF\uFF0C\u4E0D\u518D\u91CD\u8BD5`);
          throw error;
        }
        retryCount++;
        if (retryCount > maxRetries) {
          console.error(`[\u98DE\u4E66API] \u{1F4A5} \u5DF2\u8FBE\u5230\u6700\u5927\u91CD\u8BD5\u6B21\u6570 (${maxRetries})\uFF0C\u505C\u6B62\u91CD\u8BD5`);
          throw error;
        }
        let waitTime = 3e3;
        if (retryCount >= 3) {
          waitTime = 6e3;
        }
        console.log(`[\u98DE\u4E66API] \u{1F504} \u7B49\u5F85${waitTime / 1e3}\u79D2\u540E\u8FDB\u884C\u7B2C${retryCount + 1}\u6B21\u91CD\u8BD5...`);
        await new Promise((resolve) => setTimeout(resolve, waitTime));
      }
    }
    throw new Error("\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF1A\u5DF2\u8FBE\u5230\u6700\u5927\u91CD\u8BD5\u6B21\u6570");
  }
  /**
   * 获取文档所有块
   * @param documentId 文档ID
   */
  async getDocumentBlocks(documentId) {
    var _a, _b, _c;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks`;
    console.log("[\u98DE\u4E66API] \u5F00\u59CB\u83B7\u53D6\u6587\u6863\u5757:", {
      documentId,
      url,
      hasToken: !!token
    });
    const requestParam = {
      url,
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json; charset=utf-8"
      }
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      console.log("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        hasJson: !!response.json
      });
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u7ED3\u679C:", {
        code: result.code,
        msg: result.msg,
        hasData: !!result.data,
        itemsCount: ((_c = (_b = result.data) == null ? void 0 : _b.items) == null ? void 0 : _c.length) || 0,
        fullResponse: result
      });
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      if (!result.data || !result.data.items) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11items:", result);
        throw new Error("\u83B7\u53D6\u6210\u529F\u4F46\u672A\u8FD4\u56DE\u6587\u6863\u5757\u6570\u636E");
      }
      console.log("[\u98DE\u4E66API] \u6587\u6863\u5757\u83B7\u53D6\u6210\u529F\uFF0C\u5171", result.data.items.length, "\u4E2A\u5757");
      return result.data.items;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0,
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 更新文档块
   * @param documentId 文档ID
   * @param blockId 块ID
   * @param imageToken 图片token（file_token）
   */
  async updateDocumentBlock(documentId, blockId, imageToken, imageInfo) {
    var _a;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${blockId}?document_revision_id=-1`;
    let width = 800;
    let height = 600;
    if (imageInfo) {
      try {
        const dimensions = await this.getImageDimensions(imageInfo.path);
        if (dimensions) {
          width = dimensions.width;
          height = dimensions.height;
          const maxWidth = 1200;
          const maxHeight = 800;
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = Math.round(width * ratio);
            height = Math.round(height * ratio);
          }
        }
      } catch (error) {
        console.warn("[\u98DE\u4E66API] \u83B7\u53D6\u56FE\u7247\u5C3A\u5BF8\u5931\u8D25\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u5C3A\u5BF8:", error);
      }
    }
    const requestBody = {
      replace_image: {
        token: imageToken,
        width,
        height,
        align: 2
      }
    };
    console.log("[\u98DE\u4E66API] \u5F00\u59CB\u66F4\u65B0\u6587\u6863\u5757:", {
      documentId,
      blockId,
      imageToken: imageToken ? `${imageToken.substring(0, 10)}...` : "null",
      url,
      hasToken: !!token,
      requestBody
    });
    const requestBody_str = JSON.stringify(requestBody);
    const requestParam = {
      url,
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: requestBody_str
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      console.log("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        hasJson: !!response.json
      });
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u7ED3\u679C:", {
        code: result.code,
        msg: result.msg,
        hasData: !!result.data,
        fullResponse: result
      });
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      console.log("[\u98DE\u4E66API] \u6587\u6863\u5757\u66F4\u65B0\u6210\u529F");
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0,
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 处理文档中的图片（完整流程）
   * @param documentId 文档ID
   * @param imageInfos 图片信息数组
   * @param onProgress 进度回调
   */
  async processImagesInDocument(documentId, imageInfos, onProgress) {
    if (!imageInfos || imageInfos.length === 0) {
      console.log("[\u98DE\u4E66API] \u6CA1\u6709\u56FE\u7247\u9700\u8981\u5904\u7406");
      return;
    }
    console.log("[\u98DE\u4E66API] \u5F00\u59CB\u5904\u7406\u6587\u6863\u4E2D\u7684\u56FE\u7247:", {
      documentId,
      imageCount: imageInfos.length,
      images: imageInfos.map((img) => ({ fileName: img.fileName, path: img.path }))
    });
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u83B7\u53D6\u6587\u6863\u7ED3\u6784...");
      const blocks = await this.getDocumentBlocks(documentId);
      const imageBlocks = blocks.filter((block) => block.block_type === 27);
      console.log("[\u98DE\u4E66API] \u627E\u5230\u56FE\u7247\u5757:", imageBlocks.length, "\u4E2A");
      if (imageBlocks.length === 0) {
        console.log("[\u98DE\u4E66API] \u6587\u6863\u4E2D\u6CA1\u6709\u56FE\u7247\u5757\uFF0C\u65E0\u9700\u5904\u7406");
        return;
      }
      for (let i = 0; i < imageInfos.length && i < imageBlocks.length; i++) {
        const imageInfo = imageInfos[i];
        const imageBlock = imageBlocks[i];
        if (!imageInfo || !imageBlock) {
          console.warn(`[\u98DE\u4E66API] \u8DF3\u8FC7\u65E0\u6548\u7684\u56FE\u7247\u6216\u5757: ${i}`);
          continue;
        }
        onProgress == null ? void 0 : onProgress(`\u6B63\u5728\u5904\u7406\u56FE\u7247 ${i + 1}/${imageInfos.length}: ${imageInfo.fileName}`);
        try {
          const fileContent = await this.readImageFileAsBase64(imageInfo.path);
          if (!fileContent) {
            throw new Error(`\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247\u6587\u4EF6: ${imageInfo.path}`);
          }
          console.log(`[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750: ${imageInfo.fileName}`);
          const fileToken = await this.uploadImageMaterial(
            imageInfo.fileName,
            fileContent,
            documentId,
            imageBlock.block_id
          );
          console.log(`[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757: ${imageBlock.block_id}`);
          await this.updateDocumentBlock(
            documentId,
            imageBlock.block_id,
            fileToken,
            imageInfo
          );
          console.log(`[\u98DE\u4E66API] \u56FE\u7247 ${imageInfo.fileName} \u5904\u7406\u5B8C\u6210`);
        } catch (error) {
          console.error(`[\u98DE\u4E66API] \u5904\u7406\u56FE\u7247 ${imageInfo.fileName} \u5931\u8D25:`, error);
          onProgress == null ? void 0 : onProgress(`\u56FE\u7247 ${imageInfo.fileName} \u5904\u7406\u5931\u8D25: ${error instanceof Error ? error.message : String(error)}`);
        }
      }
      onProgress == null ? void 0 : onProgress("\u6240\u6709\u56FE\u7247\u5904\u7406\u5B8C\u6210\uFF01");
      console.log("[\u98DE\u4E66API] \u6587\u6863\u56FE\u7247\u5904\u7406\u6D41\u7A0B\u5B8C\u6210");
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u56FE\u7247\u5904\u7406\u6D41\u7A0B\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        documentId,
        imageCount: imageInfos.length
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u56FE\u7247\u5904\u7406\u6D41\u7A0B\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 获取图片尺寸
   * @param imagePath 图片文件路径
   * @returns 图片的宽度和高度
   */
  async getImageDimensions(imagePath) {
    var _a;
    try {
      let fullPath = imagePath;
      if (imagePath.match(/^[A-Za-z]:/) || imagePath.startsWith("/")) {
        const fileName = imagePath.split(/[\/\\]/).pop();
        if (fileName) {
          fullPath = fileName;
        }
      } else {
        fullPath = imagePath.replace(/^\.\//, "");
      }
      const file = await this.searchImageInVault(fullPath);
      if (!file) {
        console.warn("[\u98DE\u4E66API] \u65E0\u6CD5\u627E\u5230\u56FE\u7247\u6587\u4EF6:", fullPath);
        return null;
      }
      const arrayBuffer = await ((_a = this.app) == null ? void 0 : _a.vault.readBinary(file));
      if (!arrayBuffer) {
        console.warn("[\u98DE\u4E66API] \u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247\u6587\u4EF6\u5185\u5BB9:", fullPath);
        return null;
      }
      return new Promise((resolve) => {
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve({ width: img.width, height: img.height });
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          console.warn("[\u98DE\u4E66API] \u65E0\u6CD5\u89E3\u6790\u56FE\u7247\u5C3A\u5BF8:", fullPath);
          resolve(null);
        };
        img.src = url;
      });
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u83B7\u53D6\u56FE\u7247\u5C3A\u5BF8\u5931\u8D25:", error);
      return null;
    }
  }
  /**
   * 读取本地图片文件并转换为base64
   * @param imagePath 图片文件路径
   * @returns base64编码的图片内容
   */
  async readImageFileAsBase64(imagePath) {
    var _a, _b;
    try {
      let fullPath = imagePath;
      if (imagePath.match(/^[A-Za-z]:/) || imagePath.startsWith("/")) {
        const fileName = imagePath.split(/[\\/]/).pop();
        if (fileName) {
          fullPath = fileName;
        }
      } else {
        fullPath = imagePath.replace(/^\.\//, "");
      }
      console.log("[\u98DE\u4E66API] \u5C1D\u8BD5\u8BFB\u53D6\u56FE\u7247\u6587\u4EF6:", {
        originalPath: imagePath,
        fullPath
      });
      let file = (_b = (_a = this.app) == null ? void 0 : _a.vault) == null ? void 0 : _b.getAbstractFileByPath(fullPath);
      if (!file) {
        console.log("[\u98DE\u4E66API] \u76F4\u63A5\u8DEF\u5F84\u672A\u627E\u5230\uFF0C\u5F00\u59CB\u5728vault\u4E2D\u641C\u7D22\u6587\u4EF6:", fullPath);
        file = await this.searchImageInVault(fullPath);
      }
      if (!file) {
        console.error("[\u98DE\u4E66API] \u627E\u4E0D\u5230\u56FE\u7247\u6587\u4EF6:", fullPath);
        return null;
      }
      if (!("extension" in file)) {
        console.error("[\u98DE\u4E66API] \u8DEF\u5F84\u4E0D\u662F\u6709\u6548\u7684\u6587\u4EF6:", file.path);
        return null;
      }
      const arrayBuffer = await this.app.vault.readBinary(file);
      const uint8Array = new Uint8Array(arrayBuffer);
      const binaryString = Array.from(uint8Array, (byte) => String.fromCharCode(byte)).join("");
      const base64Content = btoa(binaryString);
      console.log("[\u98DE\u4E66API] \u56FE\u7247\u6587\u4EF6\u8BFB\u53D6\u6210\u529F:", {
        path: file.path,
        size: arrayBuffer.byteLength,
        base64Length: base64Content.length
      });
      return base64Content;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u8BFB\u53D6\u56FE\u7247\u6587\u4EF6\u5931\u8D25:", {
        path: imagePath,
        error: error instanceof Error ? error.message : String(error)
      });
      return null;
    }
  }
  /**
   * 在整个vault中搜索图片文件
   * @param fileName 文件名或路径
   * @returns 找到的文件对象
   */
  async searchImageInVault(fileName) {
    var _a;
    if (!((_a = this.app) == null ? void 0 : _a.vault)) {
      return null;
    }
    const targetFileName = fileName.split(/[\\/]/).pop();
    if (!targetFileName) {
      return null;
    }
    console.log("[\u98DE\u4E66API] \u5728vault\u4E2D\u641C\u7D22\u56FE\u7247\u6587\u4EF6:", targetFileName);
    const allFiles = this.app.vault.getFiles();
    const imageExtensions = [".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp", ".svg"];
    for (const file of allFiles) {
      const hasImageExtension = imageExtensions.some(
        (ext) => file.extension.toLowerCase() === ext.substring(1)
      );
      if (!hasImageExtension) {
        continue;
      }
      if (file.name === targetFileName || file.path === fileName) {
        console.log("[\u98DE\u4E66API] \u627E\u5230\u5339\u914D\u7684\u56FE\u7247\u6587\u4EF6:", file.path);
        return file;
      }
      if (!targetFileName.includes(".")) {
        const fileBaseName = file.name.substring(0, file.name.lastIndexOf("."));
        if (fileBaseName === targetFileName) {
          console.log("[\u98DE\u4E66API] \u901A\u8FC7\u57FA\u7840\u540D\u79F0\u627E\u5230\u5339\u914D\u7684\u56FE\u7247\u6587\u4EF6:", file.path);
          return file;
        }
      }
    }
    console.log("[\u98DE\u4E66API] \u5728vault\u4E2D\u672A\u627E\u5230\u56FE\u7247\u6587\u4EF6:", targetFileName);
    return null;
  }
  /**
   * 转换Obsidian图片语法为标准Markdown语法
   * @param markdownContent 包含Obsidian图片语法的Markdown内容
   * @returns 转换后的标准Markdown内容
   */
  static convertObsidianImageSyntax(markdownContent) {
    const obsidianImageRegex = /!\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g;
    let convertedContent = markdownContent;
    let match;
    let convertCount = 0;
    obsidianImageRegex.lastIndex = 0;
    while ((match = obsidianImageRegex.exec(markdownContent)) !== null) {
      const fileName = match[1];
      const altText = match[2] || fileName;
      const obsidianSyntax = match[0];
      const standardSyntax = `![${altText}](${fileName})`;
      convertedContent = convertedContent.replace(obsidianSyntax, standardSyntax);
      convertCount++;
      console.log("[\u98DE\u4E66API] \u8F6C\u6362\u56FE\u7247\u8BED\u6CD5:", {
        from: obsidianSyntax,
        to: standardSyntax,
        fileName,
        altText
      });
    }
    if (convertCount > 0) {
      console.log(`[\u98DE\u4E66API] \u56FE\u7247\u8BED\u6CD5\u8F6C\u6362\u5B8C\u6210\uFF0C\u5171\u8F6C\u6362 ${convertCount} \u4E2A\u56FE\u7247`);
    } else {
      console.log("[\u98DE\u4E66API] \u672A\u53D1\u73B0\u9700\u8981\u8F6C\u6362\u7684Obsidian\u56FE\u7247\u8BED\u6CD5");
    }
    return convertedContent;
  }
  /**
   * 提取Markdown中的图片信息
   * @param markdownContent Markdown内容
   * @param basePath 基础路径（用于解析相对路径）
   */
  static extractImageInfoFromMarkdown(markdownContent, basePath) {
    const imageInfos = [];
    const convertedContent = FeishuApiClient.convertObsidianImageSyntax(markdownContent);
    const markdownImageRegex = /!\[([^\]]*)\]\(([^\)\s]+)(?:\s+"([^"]*)")?\)/g;
    let match;
    let position = 0;
    while ((match = markdownImageRegex.exec(convertedContent)) !== null) {
      const alt = match[1];
      const path = match[2];
      const title = match[3];
      if (!path)
        continue;
      const fileName = path.split("/").pop() || path;
      const fullPath = basePath && !path.startsWith("http") ? `${basePath}/${path}` : path;
      imageInfos.push({
        path: fullPath,
        fileName,
        position: position++
      });
    }
    console.log("[\u98DE\u4E66API] \u4ECEMarkdown\u4E2D\u63D0\u53D6\u5230\u56FE\u7247:", imageInfos.length, "\u5F20");
    return imageInfos;
  }
  /**
   * 直接上传文件到飞书云盘
   * @param fileName 文件名
   * @param markdownContent Markdown内容
   * @param documentId 目标文档ID（可选）
   * @param onProgress 进度回调
   */
  async uploadFileDirectly(fileName, markdownContent, documentId, onProgress) {
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u5185\u5BB9...");
      const convertedContent = FeishuApiClient.convertObsidianImageSyntax(markdownContent);
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u4E0A\u4F20\u6587\u4EF6...");
      const fileContent = btoa(unescape(encodeURIComponent(convertedContent)));
      const fileToken = await this.uploadFile(fileName, fileContent, documentId || "");
      onProgress == null ? void 0 : onProgress("\u4E0A\u4F20\u5B8C\u6210\uFF01");
      const fileUrl = `https://open.feishu.cn/open-apis/drive/v1/files/${fileToken}`;
      return {
        token: fileToken,
        url: fileUrl
      };
    } catch (error) {
      console.error("\u76F4\u63A5\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25:", error);
      throw error;
    }
  }
  /**
   * 完整的文档上传流程（通过导入任务）
   * @param fileName 文件名
   * @param markdownContent Markdown内容
   * @param documentId 目标文档ID（可选）
   * @param onProgress 进度回调
   */
  async uploadDocument(fileName, markdownContent, documentId, onProgress) {
    var _a, _b, _c;
    let mdFileToken = null;
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u5185\u5BB9...");
      const convertedContent = FeishuApiClient.convertObsidianImageSyntax(markdownContent);
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u4E0A\u4F20\u6587\u4EF6\u5230\u4E91\u7A7A\u95F4...");
      const fileContent = btoa(unescape(encodeURIComponent(convertedContent)));
      mdFileToken = await this.uploadFile(fileName, fileContent, documentId || "");
      console.log("[\u98DE\u4E66API] MD\u6587\u4EF6\u5DF2\u4E0A\u4F20\uFF0Cfile_token:", mdFileToken);
      onProgress == null ? void 0 : onProgress("\u6587\u4EF6\u5DF2\u4E0A\u4F20\uFF0C\u6B63\u5728\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1...");
      const ticket = await this.createImportTask(fileName, mdFileToken, documentId || "");
      onProgress == null ? void 0 : onProgress("\u4EFB\u52A1\u5DF2\u521B\u5EFA\uFF0C\u6B63\u5728\u5904\u7406...");
      console.log("[\u98DE\u4E66API] \u7B49\u5F853\u79D2\u8BA9\u98DE\u4E66\u5F00\u59CB\u5904\u7406\u4EFB\u52A1...");
      await new Promise((resolve) => setTimeout(resolve, 3e3));
      onProgress == null ? void 0 : onProgress("\u5F00\u59CB\u67E5\u8BE2\u5904\u7406\u72B6\u6001...");
      const result = await this.waitForImportTask(ticket, onProgress);
      const imageInfos = FeishuApiClient.extractImageInfoFromMarkdown(markdownContent, (_c = (_b = (_a = this.app) == null ? void 0 : _a.vault) == null ? void 0 : _b.adapter) == null ? void 0 : _c.basePath);
      if (imageInfos.length > 0) {
        onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u4E2D\u7684\u56FE\u7247...");
        await this.processImagesInDocument(result.token, imageInfos, onProgress);
      }
      if (mdFileToken) {
        try {
          console.log("[\u98DE\u4E66API] \u5F00\u59CB\u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\uFF0Cfile_token:", mdFileToken);
          await this.deleteFile(mdFileToken, "file");
          console.log("[\u98DE\u4E66API] \u4E34\u65F6MD\u6587\u4EF6\u5DF2\u6E05\u7406");
        } catch (deleteError) {
          console.warn("[\u98DE\u4E66API] \u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\u5931\u8D25\uFF08\u4E0D\u5F71\u54CD\u4E3B\u529F\u80FD\uFF09:", deleteError);
        }
      }
      onProgress == null ? void 0 : onProgress("\u4E0A\u4F20\u5B8C\u6210\uFF01");
      return result;
    } catch (error) {
      if (mdFileToken) {
        try {
          console.log("[\u98DE\u4E66API] \u4E3B\u6D41\u7A0B\u5931\u8D25\uFF0C\u5C1D\u8BD5\u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6");
          await this.deleteFile(mdFileToken, "file");
        } catch (deleteError) {
          console.warn("[\u98DE\u4E66API] \u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\u5931\u8D25:", deleteError);
        }
      }
      console.error("\u4E0A\u4F20\u6587\u6863\u5931\u8D25:", error);
      throw error;
    }
  }
  /**
   * 测试API连接
   */
  async testConnection() {
    try {
      await this.getAccessToken();
      return true;
    } catch (error) {
      console.error("\u6D4B\u8BD5\u98DE\u4E66API\u8FDE\u63A5\u5931\u8D25:", error);
      return false;
    }
  }
  /**
   * 格式化飞书文档URL
   * @param url 原始URL
   * @param token 文档token
   */
  formatDocumentUrl(url, token) {
    try {
      if (url.startsWith("https://") && (url.includes("feishu.cn") || url.includes("larkoffice.com"))) {
        console.log("[\u98DE\u4E66API] URL\u5DF2\u7ECF\u662F\u5B8C\u6574\u683C\u5F0F\uFF0C\u76F4\u63A5\u8FD4\u56DE:", url);
        return url;
      }
      if (!url.startsWith("http")) {
        const formattedUrl = `https://open.feishu.cn/document/${token}`;
        console.log("[\u98DE\u4E66API] \u6784\u9020\u98DE\u4E66\u6587\u6863URL:", {
          originalUrl: url,
          token,
          formattedUrl
        });
        return formattedUrl;
      }
      console.log("[\u98DE\u4E66API] URL\u683C\u5F0F\u9700\u8981\u9A8C\u8BC1:", url);
      return url;
    } catch (error) {
      console.error("[\u98DE\u4E66API] URL\u683C\u5F0F\u5316\u5931\u8D25:", error);
      return url;
    }
  }
  /**
   * 转移文档所有权给用户
   * @param docToken 文档token
   * @param userId 用户ID
   */
  async transferDocumentOwnership(docToken, userId) {
    var _a;
    const token = await this.getAccessToken();
    console.log("[\u98DE\u4E66API] \u8F6C\u79FB\u6587\u6863\u6240\u6709\u6743:", {
      docToken,
      userId
    });
    try {
      const transferUrl = `${this.baseUrl}/drive/v1/permissions/${docToken}/members/transfer_owner?need_notification=false&old_owner_perm=full_access&remove_old_owner=false&stay_put=true&type=docx`;
      const requestBody = {
        member_id: userId,
        member_type: "userid"
      };
      const requestParam = {
        url: transferUrl,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      console.log("[\u98DE\u4E66API] \u6240\u6709\u6743\u8F6C\u79FB\u8BF7\u6C42\u53C2\u6570:", {
        url: transferUrl,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token.substring(0, 20)}...`,
          "Content-Type": "application/json"
        },
        requestBody,
        bodyString: JSON.stringify(requestBody)
      });
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u6240\u6709\u6743\u8F6C\u79FB\u54CD\u5E94:", {
        status: response.status,
        code: result.code,
        msg: result.msg,
        fullResponse: result
      });
      if (result.code === 0) {
        console.log("[\u98DE\u4E66API] \u2705 \u6587\u6863\u6240\u6709\u6743\u8F6C\u79FB\u6210\u529F");
        return true;
      } else {
        console.error("[\u98DE\u4E66API] \u274C \u6587\u6863\u6240\u6709\u6743\u8F6C\u79FB\u5931\u8D25:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u8F6C\u79FB\u6587\u6863\u6240\u6709\u6743\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u274C \u6240\u6709\u6743\u8F6C\u79FB\u5F02\u5E38:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        status: error.status,
        statusText: error.statusText,
        response: error.response,
        json: error.json
      });
      throw error;
    }
  }
  /**
   * 设置文档权限
   * @param docToken 文档token
   * @param permissions 权限设置
   * @param userId 用户ID（用于所有权转移）
   */
  async setDocumentPermissions(docToken, permissions, userId) {
    var _a, _b;
    const token = await this.getAccessToken();
    const now = Date.now();
    console.log("[\u98DE\u4E66API] \u4EE4\u724C\u72B6\u6001\u68C0\u67E5:", {
      hasToken: !!this.accessToken,
      tokenLength: ((_a = this.accessToken) == null ? void 0 : _a.length) || 0,
      tokenPrefix: ((_b = this.accessToken) == null ? void 0 : _b.substring(0, 20)) + "...",
      currentTime: new Date(now).toISOString(),
      expireTime: new Date(this.tokenExpireTime).toISOString(),
      timeUntilExpire: this.tokenExpireTime - now,
      isExpired: now >= this.tokenExpireTime
    });
    console.log("[\u98DE\u4E66API] \u8BBE\u7F6E\u6587\u6863\u6743\u9650:", {
      docToken,
      permissions,
      userId
    });
    try {
      if (userId) {
        console.log("[\u98DE\u4E66API] \u7B2C\u96F6\u6B65\uFF1A\u8F6C\u79FB\u6587\u6863\u6240\u6709\u6743\u7ED9\u7528\u6237");
        await this.transferDocumentOwnership(docToken, userId);
        console.log("[\u98DE\u4E66API] \u7B49\u5F851\u79D2\u8BA9\u6240\u6709\u6743\u8F6C\u79FB\u751F\u6548...");
        await new Promise((resolve) => setTimeout(resolve, 1e3));
      }
      const requestBody = {
        external_access_entity: "open"
      };
      if (permissions.isPublic) {
        requestBody.link_share_entity = "anyone_readable";
      }
      if (permissions.copyEntity) {
        requestBody.copy_entity = permissions.copyEntity;
      } else if (permissions.allowCopy) {
        requestBody.copy_entity = "anyone_can_view";
      }
      if (permissions.securityEntity) {
        requestBody.security_entity = permissions.securityEntity;
      } else if (permissions.allowCreateCopy || permissions.allowPrintDownload) {
        requestBody.security_entity = "anyone_can_view";
      }
      console.log("[\u98DE\u4E66API] \u8BBE\u7F6E\u6240\u6709\u6743\u9650", {
        requestBody,
        bodyString: JSON.stringify(requestBody)
      });
      const publicUrl = `${this.baseUrl}/drive/v2/permissions/${docToken}/public?type=docx`;
      await this.executePermissionRequest(publicUrl, token, requestBody, "\u6743\u9650\u8BBE\u7F6E");
      console.log("[\u98DE\u4E66API] \u2705 \u6240\u6709\u6743\u9650\u8BBE\u7F6E\u5B8C\u6210");
      return true;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u274C \u6743\u9650\u8BBE\u7F6E\u5931\u8D25:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        status: error.status,
        statusText: error.statusText,
        response: error.response,
        json: error.json
      });
      throw error;
    }
  }
  /**
   * 仅更新文档权限（不包含所有权转移）
   * @param docToken 文档token
   * @param permissions 权限设置
   */
  async updateDocumentPermissionsOnly(docToken, permissions) {
    const token = await this.getAccessToken();
    console.log("[\u98DE\u4E66API] \u4EC5\u66F4\u65B0\u6587\u6863\u6743\u9650:", {
      docToken,
      permissions
    });
    try {
      const requestBody = {
        external_access_entity: "open"
      };
      if (permissions.isPublic) {
        requestBody.link_share_entity = "anyone_readable";
      }
      if (permissions.copyEntity) {
        requestBody.copy_entity = permissions.copyEntity;
      } else if (permissions.allowCopy) {
        requestBody.copy_entity = "anyone_can_view";
      }
      if (permissions.securityEntity) {
        requestBody.security_entity = permissions.securityEntity;
      } else if (permissions.allowCreateCopy || permissions.allowPrintDownload) {
        requestBody.security_entity = "anyone_can_view";
      }
      console.log("[\u98DE\u4E66API] \u8BBE\u7F6E\u6743\u9650\uFF08\u65E0\u6240\u6709\u6743\u8F6C\u79FB\uFF09", {
        requestBody,
        bodyString: JSON.stringify(requestBody)
      });
      const publicUrl = `${this.baseUrl}/drive/v2/permissions/${docToken}/public?type=docx`;
      await this.executePermissionRequest(publicUrl, token, requestBody, "\u6743\u9650\u8BBE\u7F6E\uFF08\u65E0\u6240\u6709\u6743\u8F6C\u79FB\uFF09");
      console.log("[\u98DE\u4E66API] \u2705 \u6743\u9650\u8BBE\u7F6E\u5B8C\u6210\uFF08\u65E0\u6240\u6709\u6743\u8F6C\u79FB\uFF09");
      return true;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u274C \u6743\u9650\u8BBE\u7F6E\u5931\u8D25\uFF08\u65E0\u6240\u6709\u6743\u8F6C\u79FB\uFF09:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        status: error.status,
        statusText: error.statusText,
        response: error.response,
        json: error.json
      });
      throw error;
    }
  }
  /**
   * 执行权限设置请求（带重试机制）
   */
  async executePermissionRequest(url, token, requestBody, stepName) {
    var _a;
    let retryCount = 0;
    const maxRetries = 3;
    const retryDelay = 1e4;
    while (retryCount <= maxRetries) {
      try {
        const requestParam = {
          url,
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json; charset=utf-8"
          },
          body: JSON.stringify(requestBody)
        };
        console.log(`[\u98DE\u4E66API] ${stepName}\u8BF7\u6C42 (\u7B2C${retryCount + 1}\u6B21):`, {
          url,
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token.substring(0, 20)}...`,
            "Content-Type": "application/json; charset=utf-8"
          },
          requestBody,
          bodyString: JSON.stringify(requestBody)
        });
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
        const result = response.json;
        console.log(`[\u98DE\u4E66API] ${stepName}\u54CD\u5E94 (\u7B2C${retryCount + 1}\u6B21):`, {
          status: response.status,
          code: result.code,
          msg: result.msg,
          fullResponse: result
        });
        if (result.code === 0) {
          console.log(`[\u98DE\u4E66API] \u2705 ${stepName}\u6210\u529F`);
          return;
        } else {
          console.error(`[\u98DE\u4E66API] \u274C ${stepName}\u5931\u8D25:`, {
            code: result.code,
            msg: result.msg,
            fullResult: result
          });
          throw new Error(`${stepName}\u5931\u8D25: [${result.code}] ${result.msg}`);
        }
      } catch (error) {
        console.error(`[\u98DE\u4E66API] \u274C ${stepName}\u7B2C${retryCount + 1}\u6B21\u8BF7\u6C42\u5F02\u5E38:`, {
          error,
          errorMessage: error instanceof Error ? error.message : String(error),
          status: error.status,
          statusText: error.statusText,
          response: error.response,
          json: error.json,
          retryCount,
          maxRetries
        });
        if (error.status === 500 && retryCount < maxRetries) {
          retryCount++;
          console.warn(`[\u98DE\u4E66API] \u26A0\uFE0F ${stepName}\u9047\u5230500\u9519\u8BEF\uFF0C${retryDelay / 1e3}\u79D2\u540E\u8FDB\u884C\u7B2C${retryCount + 1}\u6B21\u91CD\u8BD5...`);
          await new Promise((resolve) => setTimeout(resolve, retryDelay));
          continue;
        } else {
          console.error(`[\u98DE\u4E66API] \u274C ${stepName}\u6700\u7EC8\u5931\u8D25:`, {
            error,
            errorMessage: error instanceof Error ? error.message : String(error),
            status: error.status,
            statusText: error.statusText,
            response: error.response,
            json: error.json,
            retryCount,
            maxRetries
          });
          throw error;
        }
      }
    }
    if (retryCount > maxRetries) {
      throw new Error(`${stepName}\u5931\u8D25\uFF1A\u670D\u52A1\u5668\u9519\u8BEF\uFF0C\u5DF2\u91CD\u8BD53\u6B21\u4ECD\u65E0\u6CD5\u5B8C\u6210`);
    }
  }
  /**
   * 更新应用凭证
   */
  /**
   * 删除文件
   * @param docToken 文档token
   * @param fileType 文件类型
   */
  async deleteFile(docToken, fileType = "docx") {
    var _a;
    const token = await this.getAccessToken();
    console.log("[\u98DE\u4E66API] \u5220\u9664\u6587\u4EF6:", {
      docToken,
      fileType
    });
    try {
      const deleteUrl = `${this.baseUrl}/drive/v1/files/${docToken}?type=${fileType}`;
      const requestParam = {
        url: deleteUrl,
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json; charset=utf-8"
        }
      };
      console.log("[\u98DE\u4E66API] \u5220\u9664\u6587\u4EF6\u8BF7\u6C42\u53C2\u6570:", {
        url: deleteUrl,
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token.substring(0, 20)}...`,
          "Content-Type": "application/json; charset=utf-8"
        }
      });
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u5220\u9664\u6587\u4EF6\u54CD\u5E94:", {
        status: response.status,
        code: result.code,
        msg: result.msg,
        fullResponse: result
      });
      if (result.code === 0) {
        console.log("[\u98DE\u4E66API] \u2705 \u6587\u4EF6\u5220\u9664\u6210\u529F");
        return true;
      } else {
        console.error("[\u98DE\u4E66API] \u274C \u6587\u4EF6\u5220\u9664\u5931\u8D25:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u274C \u5220\u9664\u6587\u4EF6\u5F02\u5E38:", {
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        status: error.status,
        statusText: error.statusText,
        response: error.response,
        json: error.json
      });
      throw error;
    }
  }
  updateCredentials(appId, appSecret) {
    this.appId = appId;
    this.appSecret = appSecret;
    this.accessToken = null;
    this.tokenExpireTime = 0;
  }
  /**
   * 获取文档所有块的详细信息（支持 Callout 转换）
   * @param documentId 文档ID
   * @returns 文档块数组（包含完整的块信息）
   */
  async getDocumentBlocksDetailed(documentId) {
    try {
      const token = await this.getAccessToken();
      const allBlocks = [];
      let pageToken;
      let hasMore = true;
      while (hasMore) {
        const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks`;
        const params = {
          page_size: 500,
          user_id_type: "user_id"
        };
        if (pageToken) {
          params.page_token = pageToken;
        }
        const requestParam = {
          url: url + "?" + new URLSearchParams(params).toString(),
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        };
        console.log("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u8BE6\u7EC6\u4FE1\u606F:", {
          documentId,
          pageToken,
          url: requestParam.url
        });
        if (this.apiCallCountCallback) {
          this.apiCallCountCallback();
        }
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        const result = response.json;
        if (result.code !== 0) {
          throw new Error(`\u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
        }
        allBlocks.push(...result.data.items);
        hasMore = result.data.has_more;
        pageToken = result.data.page_token;
        console.log("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u8BE6\u7EC6\u4FE1\u606F\u6210\u529F:", {
          currentBatch: result.data.items.length,
          totalSoFar: allBlocks.length,
          hasMore
        });
      }
      return allBlocks;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u8BE6\u7EC6\u4FE1\u606F\u5931\u8D25:", {
        documentId,
        error,
        errorMessage: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }
  /**
   * 批量更新文档块（支持 Callout 转换）
   * @param documentId 文档ID
   * @param requests 批量更新请求数组
   * @returns 更新结果
   */
  async batchUpdateDocumentBlocks(documentId, requests) {
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/batch_update?document_revision_id=-1`;
      const requestBody = {
        requests
      };
      const requestParam = {
        url,
        method: "PATCH",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      console.log("[\u98DE\u4E66API] \u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757:", {
        documentId,
        requestCount: requests.length,
        requests: requests.map((req) => ({
          hasInsertBlock: !!req.insert_block,
          hasUpdateTextElements: !!req.update_text_elements,
          hasMergeTableCells: !!req.merge_table_cells,
          hasReplaceImage: !!req.replace_image,
          blockId: req.block_id,
          parentId: req.parent_id,
          index: req.index
        }))
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      if (result.code !== 0) {
        throw new Error(`\u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
      }
      console.log("[\u98DE\u4E66API] \u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757\u6210\u529F:", {
        documentId,
        updatedCount: requests.length,
        result: result.data
      });
      return result.data;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25:", {
        documentId,
        requestCount: requests.length,
        error,
        errorMessage: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }
  /**
   * 创建文档块
   * @param documentId 文档ID
   * @param parentId 父块ID
   * @param index 插入位置索引
   * @param children 要创建的子块数组
   * @returns 创建结果
   */
  async createDocumentBlocks(documentId, parentId, index, children) {
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/children?document_revision_id=-1`;
      const requestBody = {
        index,
        children
      };
      const requestParam = {
        url,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757:", {
        documentId,
        parentId,
        index,
        childrenCount: children.length,
        requestBody
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u539F\u59CB\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        body: result
      });
      if (result.code !== 0) {
        const errorDetails = {
          code: result.code,
          msg: result.msg,
          data: result.data,
          httpStatus: response.status,
          requestUrl: url,
          requestBody
        };
        console.error("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u8BE6\u7EC6\u9519\u8BEF\u4FE1\u606F:", errorDetails);
        throw new Error(`\u521B\u5EFA\u6587\u6863\u5757\u5931\u8D25: ${result.msg} (code: ${result.code})`);
      }
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u6210\u529F:", {
        documentId,
        parentId,
        index,
        result: result.data
      });
      return result.data;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u5931\u8D25:", {
        documentId,
        parentId,
        index,
        childrenCount: children.length,
        requestUrl: `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/children?document_revision_id=-1`,
        requestBody: {
          index,
          children
        },
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0
      });
      throw error;
    }
  }
  /**
   * 创建嵌套文档块（使用descendant API）
   * @param documentId 文档ID
   * @param parentId 父块ID
   * @param index 插入位置索引
   * @param childrenIds 子块ID数组
   * @param descendants 嵌套块定义数组
   * @returns 创建结果
   */
  async createDocumentDescendants(documentId, parentId, index, childrenIds, descendants) {
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/descendant?document_revision_id=-1`;
      const requestBody = {
        children_id: childrenIds,
        descendants,
        index
      };
      const requestParam = {
        url,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757:", {
        documentId,
        parentId,
        index,
        childrenIds,
        descendantsCount: descendants.length,
        requestBody
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u539F\u59CB\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        body: result
      });
      if (result.code !== 0) {
        const errorDetails = {
          code: result.code,
          msg: result.msg,
          data: result.data,
          httpStatus: response.status,
          requestUrl: url,
          requestBody
        };
        console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u8BE6\u7EC6\u9519\u8BEF\u4FE1\u606F:", errorDetails);
        throw new Error(`\u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u5931\u8D25: ${result.msg} (code: ${result.code})`);
      }
      console.log("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u6210\u529F:", {
        documentId,
        parentId,
        index,
        result: result.data
      });
      return result.data;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u5931\u8D25:", {
        documentId,
        parentId,
        index,
        childrenIds,
        descendantsCount: descendants.length,
        requestUrl: `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/descendant?document_revision_id=-1`,
        requestBody: {
          children_id: childrenIds,
          descendants,
          index
        },
        error,
        errorMessage: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : void 0
      });
      throw error;
    }
  }
  /**
   * 删除文档块
   * @param documentId 文档ID
   * @param blockId 块ID
   * @returns 删除结果
   */
  async deleteDocumentBlock(documentId, blockId, parentId, index) {
    return this.queueDeleteRequest(async () => {
      try {
        const token = await this.getAccessToken();
        const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId || blockId}/children/batch_delete?document_revision_id=-1`;
        const deleteBody = index !== void 0 ? {
          start_index: index,
          end_index: index + 1
        } : {
          block_ids: [blockId]
        };
        const requestParam = {
          url,
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(deleteBody)
        };
        console.log("[\u98DE\u4E66API] \u5220\u9664\u6587\u6863\u5757:", {
          documentId,
          blockId,
          parentId,
          index,
          deleteMethod: index !== void 0 ? "by_index" : "by_block_id",
          deleteBody
        });
        if (this.apiCallCountCallback) {
          this.apiCallCountCallback();
        }
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        const result = response.json;
        if (result.code !== 0) {
          throw new Error(`\u5220\u9664\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
        }
        console.log("[\u98DE\u4E66API] \u5220\u9664\u6587\u6863\u5757\u6210\u529F:", {
          documentId,
          blockId,
          result: result.data
        });
        return result.data;
      } catch (error) {
        console.error("[\u98DE\u4E66API] \u5220\u9664\u6587\u6863\u5757\u5931\u8D25:", {
          documentId,
          blockId,
          error,
          errorMessage: error instanceof Error ? error.message : String(error)
        });
        throw error;
      }
    });
  }
  /**
   * 转换 Markdown 为文档块（支持 Callout 检测）
   * @param content Markdown 内容
   * @returns 转换结果
   */
  async convertMarkdownToBlocks(content) {
    var _a, _b;
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/content/blocks`;
      const requestBody = {
        content,
        format: "markdown"
      };
      const requestParam = {
        url,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      console.log("[\u98DE\u4E66API] \u8F6C\u6362 Markdown \u4E3A\u6587\u6863\u5757:", {
        contentLength: content.length,
        contentPreview: content.substring(0, 100) + (content.length > 100 ? "..." : "")
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      if (result.code !== 0) {
        throw new Error(`\u8F6C\u6362 Markdown \u5931\u8D25: ${result.msg}`);
      }
      console.log("[\u98DE\u4E66API] \u8F6C\u6362 Markdown \u6210\u529F:", {
        blocksCount: ((_b = (_a = result.data) == null ? void 0 : _a.blocks) == null ? void 0 : _b.length) || 0
      });
      return result.data;
    } catch (error) {
      console.error("[\u98DE\u4E66API] \u8F6C\u6362 Markdown \u5931\u8D25:", {
        contentLength: content.length,
        error,
        errorMessage: error instanceof Error ? error.message : String(error)
      });
      throw error;
    }
  }
};
function createFeishuClient(appId, appSecret, app, apiCallCountCallback) {
  return new FeishuApiClient(appId, appSecret, app, apiCallCountCallback);
}

// crypto-utils.ts
var _CryptoUtils = class {
  /**
   * 获取缓存的加密密钥，如果不存在则生成新的
   */
  static async getEncryptionKey() {
    if (this.encryptionKey) {
      return this.encryptionKey;
    }
    this.encryptionKey = await this.generateDeviceKey();
    return this.encryptionKey;
  }
  /**
   * 生成基于设备特征的固定密钥
   * 使用设备的硬件和系统信息生成唯一且稳定的密钥
   */
  static async generateDeviceKey() {
    const deviceInfo = [
      navigator.userAgent,
      // 用户代理
      navigator.platform,
      // 平台信息
      navigator.language,
      // 语言设置
      screen.width + "x" + screen.height,
      // 屏幕分辨率
      new Date().getTimezoneOffset().toString(),
      // 时区偏移
      window.location.hostname || "obsidian",
      // 主机名
      "feishu-plugin-v1"
      // 插件标识
    ].join("|");
    const encoder = new TextEncoder();
    const data = encoder.encode(deviceInfo);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return await crypto.subtle.importKey(
      "raw",
      hashBuffer,
      { name: this.ALGORITHM },
      false,
      ["encrypt", "decrypt"]
    );
  }
  /**
   * 加密敏感字符串
   * @param plaintext 明文字符串
   * @returns 加密后的字符串（Base64编码）
   */
  static async encrypt(plaintext) {
    if (!plaintext || plaintext.trim() === "") {
      return plaintext;
    }
    if (this.lastEncryptedData === plaintext && this.lastEncryptedResult) {
      return this.lastEncryptedResult;
    }
    try {
      const key = await this.getEncryptionKey();
      const iv = crypto.getRandomValues(new Uint8Array(this.IV_LENGTH));
      const encoder = new TextEncoder();
      const data = encoder.encode(plaintext);
      const encrypted = await crypto.subtle.encrypt(
        {
          name: this.ALGORITHM,
          iv
        },
        key,
        data
      );
      const combined = new Uint8Array(iv.length + encrypted.byteLength);
      combined.set(iv);
      combined.set(new Uint8Array(encrypted), iv.length);
      const result = this.arrayBufferToBase64(combined.buffer);
      this.lastEncryptedData = plaintext;
      this.lastEncryptedResult = result;
      return result;
    } catch (error) {
      console.error("[\u52A0\u5BC6\u5DE5\u5177] \u52A0\u5BC6\u5931\u8D25:", error);
      return plaintext;
    }
  }
  /**
   * 解密敏感字符串
   * @param encryptedData 加密的字符串（Base64编码）
   * @returns 解密后的明文字符串
   */
  static async decrypt(encryptedData) {
    if (!encryptedData || encryptedData.trim() === "") {
      return encryptedData;
    }
    if (!this.isEncryptedData(encryptedData)) {
      return encryptedData;
    }
    try {
      const key = await this.getEncryptionKey();
      const combined = this.base64ToArrayBuffer(encryptedData);
      const combinedArray = new Uint8Array(combined);
      const iv = combinedArray.slice(0, this.IV_LENGTH);
      const encrypted = combinedArray.slice(this.IV_LENGTH);
      const decrypted = await crypto.subtle.decrypt(
        {
          name: this.ALGORITHM,
          iv
        },
        key,
        encrypted
      );
      const decoder = new TextDecoder();
      return decoder.decode(decrypted);
    } catch (error) {
      console.error("[\u52A0\u5BC6\u5DE5\u5177] \u89E3\u5BC6\u5931\u8D25:", error);
      return encryptedData;
    }
  }
  /**
  * 判断字符串是否为加密数据
  * @param data 待检查的字符串
  * @returns 是否为加密数据
  */
  static isEncryptedData(data) {
    const base64Regex = /^[A-Za-z0-9+/]+=*$/;
    if (!base64Regex.test(data)) {
      return false;
    }
    try {
      const decoded = this.base64ToArrayBuffer(data);
      return decoded.byteLength >= this.IV_LENGTH + 1;
    } catch (e) {
      return false;
    }
  }
  /**
   * ArrayBuffer转Base64
   */
  static arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) {
      const byte = bytes[i];
      if (byte !== void 0) {
        binary += String.fromCharCode(byte);
      }
    }
    return btoa(binary);
  }
  /**
   * Base64转ArrayBuffer
   */
  static base64ToArrayBuffer(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
  }
  /**
   * 加密敏感设置对象（带缓存优化）
   * @param settings 设置对象
   * @returns 加密后的设置对象
   */
  static async encryptSensitiveSettings(settings) {
    const sensitiveData = this.extractSensitiveData(settings);
    const sensitiveDataString = JSON.stringify(sensitiveData);
    if (this.lastEncryptedData === sensitiveDataString && this.lastEncryptedResult) {
      return { ...settings, ...this.lastEncryptedResult };
    }
    const encrypted = { ...settings };
    const encryptedFields = {};
    for (const field of this.SENSITIVE_FIELDS) {
      if (encrypted[field] && typeof encrypted[field] === "string") {
        encryptedFields[field] = await _CryptoUtils.encrypt(encrypted[field]);
        encrypted[field] = encryptedFields[field];
      }
    }
    this.lastEncryptedData = sensitiveDataString;
    this.lastEncryptedResult = encryptedFields;
    return encrypted;
  }
  /**
   * 提取敏感数据用于缓存比较
   */
  static extractSensitiveData(settings) {
    const sensitiveData = {};
    for (const field of this.SENSITIVE_FIELDS) {
      if (settings[field]) {
        sensitiveData[field] = settings[field];
      }
    }
    return sensitiveData;
  }
  /**
   * 解密敏感设置对象（带缓存优化）
   * @param settings 加密的设置对象
   * @returns 解密后的设置对象
   */
  static async decryptSensitiveSettings(settings) {
    const result = { ...settings };
    let hasEncryptedData = false;
    for (const field of this.SENSITIVE_FIELDS) {
      if (settings[field] && typeof settings[field] === "string") {
        try {
          if (this.isEncryptedData(settings[field])) {
            result[field] = await this.decrypt(settings[field]);
            hasEncryptedData = true;
          } else {
            result[field] = settings[field];
          }
        } catch (error) {
          console.warn(`[\u52A0\u5BC6\u5DE5\u5177] \u5B57\u6BB5 ${field} \u89E3\u5BC6\u5931\u8D25\uFF0C\u53EF\u80FD\u662F\u672A\u52A0\u5BC6\u6570\u636E:`, error);
          result[field] = settings[field];
        }
      }
    }
    if (!hasEncryptedData) {
      this.clearCache();
    }
    return result;
  }
  /**
   * 清空缓存
   */
  static clearCache() {
    this.lastEncryptedData = null;
    this.lastEncryptedResult = null;
  }
};
var CryptoUtils = _CryptoUtils;
// 加密算法配置
CryptoUtils.ALGORITHM = "AES-GCM";
CryptoUtils.KEY_LENGTH = 256;
// 256 bits
CryptoUtils.IV_LENGTH = 12;
// 96 bits for GCM
// 敏感字段列表
CryptoUtils.SENSITIVE_FIELDS = ["appId", "appSecret", "folderToken", "userId"];
// 缓存机制
CryptoUtils.encryptionKey = null;
CryptoUtils.lastEncryptedData = null;
CryptoUtils.lastEncryptedResult = null;

// callout-converter.ts
var _CalloutConverter = class {
  constructor(feishuClient) {
    this.feishuClient = feishuClient;
  }
  /**
   * 从 Markdown 文本中提取所有 Callout
   * @param markdown Markdown 文本
   * @returns Callout 信息数组
   */
  extractCallouts(markdown) {
    const callouts = [];
    let match;
    console.log("[Callout\u8C03\u8BD5] \u8F93\u5165\u7684markdown\u957F\u5EA6:", markdown.length);
    console.log("[Callout\u8C03\u8BD5] \u8F93\u5165\u7684markdown\u524D500\u5B57\u7B26:", markdown.substring(0, 500));
    console.log("[Callout\u8C03\u8BD5] \u4F7F\u7528\u7684\u6B63\u5219\u8868\u8FBE\u5F0F:", _CalloutConverter.CALLOUT_REGEX);
    const testRegex = /^> \[!([A-Za-z]+)\]/gm;
    testRegex.lastIndex = 0;
    let testMatch;
    console.log("[Callout\u8C03\u8BD5] \u6D4B\u8BD5\u7B80\u5316\u6B63\u5219\u8868\u8FBE\u5F0F\u5339\u914D:");
    while ((testMatch = testRegex.exec(markdown)) !== null) {
      console.log("[Callout\u8C03\u8BD5] \u7B80\u5316\u6B63\u5219\u627E\u5230:", testMatch[0], "\u7C7B\u578B:", testMatch[1]);
    }
    const newRegex = /^> \[!([A-Za-z]+)\][+-]?[^\n]*(?:\n((?:> .*\n?)*))?/gm;
    newRegex.lastIndex = 0;
    let newMatch;
    console.log("[Callout\u8C03\u8BD5] \u6D4B\u8BD5\u65B0\u6B63\u5219\u8868\u8FBE\u5F0F\u5339\u914D:");
    while ((newMatch = newRegex.exec(markdown)) !== null) {
      console.log("[Callout\u8C03\u8BD5] \u65B0\u6B63\u5219\u627E\u5230:", newMatch[0], "\u7C7B\u578B:", newMatch[1], "\u5185\u5BB9:", newMatch[2]);
    }
    const lines = markdown.split("\n");
    console.log("[Callout\u8C03\u8BD5] \u524D10\u884C\u5185\u5BB9:");
    for (let i = 0; i < Math.min(10, lines.length); i++) {
      const line = lines[i];
      if (line !== void 0) {
        console.log(`[Callout\u8C03\u8BD5] \u7B2C${i + 1}\u884C: "${line}" (\u957F\u5EA6: ${line.length})`);
        if (line.startsWith("> [!")) {
          console.log(`[Callout\u8C03\u8BD5] \u7B2C${i + 1}\u884C\u5B57\u7B26\u7801:`, Array.from(line).map((c) => c.charCodeAt(0)));
        }
      }
    }
    _CalloutConverter.CALLOUT_REGEX.lastIndex = 0;
    while ((match = _CalloutConverter.CALLOUT_REGEX.exec(markdown)) !== null) {
      console.log("[Callout\u8C03\u8BD5] \u627E\u5230\u5339\u914D:", match);
      const [fullMatch, type, contentBlock] = match;
      if (!type)
        continue;
      const startIndex = match.index;
      const endIndex = startIndex + fullMatch.length;
      const contentLines = [];
      if (contentBlock) {
        const lines2 = contentBlock.split("\n");
        for (const line of lines2) {
          if (line.startsWith("> ")) {
            contentLines.push(line.substring(2));
          } else if (line.trim()) {
            contentLines.push(line);
          }
        }
      }
      const processedContent = contentLines.join("\n").trim();
      callouts.push({
        type: type.toUpperCase(),
        content: processedContent || "\u65E0\u5185\u5BB9",
        originalText: fullMatch,
        startIndex,
        endIndex
      });
    }
    return callouts;
  }
  /**
   * 获取 Callout 类型对应的飞书背景色
   * @param type Callout 类型
   * @returns 飞书背景色
   */
  getBackgroundColor(type) {
    return _CalloutConverter.CALLOUT_TYPE_MAPPING[type.toUpperCase()] || "LightGrayBackground";
  }
  /**
   * 获取飞书API需要的数字格式背景颜色
   * @param type Callout类型
   * @returns 数字格式的背景颜色
   */
  getBackgroundColorNumber(type) {
    return _CalloutConverter.CALLOUT_COLOR_NUMBER_MAPPING[type.toUpperCase()] || 1;
  }
  /**
   * 创建飞书高亮块结构
   * @param callout Callout 信息
   * @returns 飞书高亮块结构
   */
  createFeishuCalloutBlock(callout) {
    const backgroundColor = this.getBackgroundColor(callout.type);
    const emoji = this.getEmojiForType(callout.type);
    return {
      block_type: 19,
      // 高亮块类型
      callout: {
        background_color: backgroundColor,
        icon: {
          emoji
        },
        children: [
          {
            block_type: 2,
            // 文本块类型
            text: {
              elements: [
                {
                  text_run: {
                    content: callout.content
                  }
                }
              ]
            }
          }
        ]
      }
    };
  }
  /**
   * 创建包含完整内容的飞书Callout块（用于从引用块转换）
   * @param type Callout类型
   * @param content 实际内容
   * @returns 飞书块对象
   */
  createFeishuCalloutBlockWithContent(type, content) {
    const backgroundColor = this.getBackgroundColor(type);
    const emoji = this.getEmojiForType(type);
    return {
      block_type: 19,
      // 高亮块类型
      callout: {
        background_color: backgroundColor,
        icon: {
          emoji
        },
        children: [
          {
            block_type: 2,
            // 文本块类型
            text: {
              elements: [
                {
                  text_run: {
                    content
                  }
                }
              ]
            }
          }
        ]
      }
    };
  }
  /**
   * 创建嵌套的飞书Callout块结构（用于descendant API）
   * @param callout Callout信息
   * @returns 嵌套块结构
   */
  createFeishuCalloutDescendants(callout) {
    const backgroundColorNumber = this.getBackgroundColorNumber(callout.type);
    const calloutBlockId = `callout_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const textBlockId = `text_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    return {
      childrenIds: [calloutBlockId],
      descendants: [
        {
          block_id: calloutBlockId,
          block_type: 19,
          callout: {
            background_color: backgroundColorNumber,
            border_color: 2,
            text_color: 5
          },
          children: [textBlockId]
        },
        {
          block_id: textBlockId,
          block_type: 2,
          children: [],
          text: {
            elements: [
              {
                text_run: {
                  content: callout.content
                }
              }
            ]
          }
        }
      ]
    };
  }
  /**
   * 根据callout类型获取emoji
   * @param type Callout类型
   * @returns emoji字符串
   */
  getEmojiForType(type) {
    const emojiMap = {
      "note": "\u{1F4DD}",
      "info": "\u2139\uFE0F",
      "abstract": "\u{1F4C4}",
      "tip": "\u{1F4A1}",
      "hint": "\u{1F4A1}",
      "success": "\u2705",
      "warning": "\u26A0\uFE0F",
      "caution": "\u26A0\uFE0F",
      "error": "\u274C",
      "danger": "\u26A0\uFE0F",
      "question": "\u2753",
      "help": "\u2753",
      "faq": "\u2753"
    };
    return emojiMap[type.toLowerCase()] || "\u{1F4CC}";
  }
  /**
   * 在飞书文档块中查找对应的引用块
   * @param blocks 飞书文档块数组
   * @param callouts 提取的 Callout 信息
   * @returns 匹配的块信息
   */
  findMatchingQuoteBlocks(blocks, callouts) {
    const matches = [];
    for (const callout of callouts) {
      const matchingBlock = blocks.find((block) => {
        if (block.block_type !== 15)
          return false;
        if (block.quote && block.quote.elements) {
          const blockContent = block.quote.elements.map((element) => {
            var _a;
            return ((_a = element.text_run) == null ? void 0 : _a.content) || "";
          }).join("").trim();
          console.log("[Callout\u8C03\u8BD5] \u68C0\u67E5\u5F15\u7528\u5757\u5185\u5BB9:", blockContent);
          console.log("[Callout\u8C03\u8BD5] Callout\u539F\u59CB\u6587\u672C:", callout.originalText);
          const calloutPattern = `[!${callout.type.toLowerCase()}]`;
          const hasCalloutMarker = blockContent.includes(calloutPattern) || blockContent.includes(`[!${callout.type.toUpperCase()}]`);
          console.log("[Callout\u8C03\u8BD5] \u67E5\u627E\u6A21\u5F0F:", calloutPattern, "\u662F\u5426\u5339\u914D:", hasCalloutMarker);
          return hasCalloutMarker;
        }
        return false;
      });
      if (matchingBlock) {
        console.log("[Callout\u8C03\u8BD5] \u627E\u5230\u5339\u914D\u7684\u5F15\u7528\u5757:", matchingBlock.block_id);
        matches.push({ callout, block: matchingBlock });
      } else {
        console.log("[Callout\u8C03\u8BD5] \u672A\u627E\u5230\u5339\u914D\u7684\u5F15\u7528\u5757\uFF0CCallout\u7C7B\u578B:", callout.type);
      }
    }
    return matches;
  }
  /**
   * 处理单个 Callout 转换（插入新块并删除原块）
   * @param documentId 文档ID
   * @param callout Callout信息
   * @param block 原引用块
   * @returns 转换结果
   */
  async processSingleCalloutConversion(documentId, callout, block) {
    var _a, _b;
    try {
      console.log("[Callout\u8F6C\u6362] \u5F00\u59CB\u5904\u7406\u5355\u4E2ACallout\u8F6C\u6362:", {
        documentId,
        calloutType: callout.type,
        blockId: block.block_id,
        parentId: block.parent_id,
        index: block.index
      });
      if (block.index !== void 0 && block.parent_id) {
        const actualParentId = block.parent_id;
        console.log("[Callout\u8F6C\u6362] \u7236\u5757ID\u786E\u5B9A:", {
          parentId: block.parent_id,
          actualParentId,
          documentId
        });
        const blockContent = ((_b = (_a = block.quote) == null ? void 0 : _a.elements) == null ? void 0 : _b.map((element) => {
          var _a2;
          return ((_a2 = element.text_run) == null ? void 0 : _a2.content) || "";
        }).join("").trim()) || "";
        console.log("[Callout\u8F6C\u6362] \u63D0\u53D6\u7684\u539F\u5757\u5185\u5BB9:", blockContent);
        const match = blockContent.match(/\[!(\w+)\]([+-]?)\s*(.*)$/s);
        const actualContent = match && match[3] ? match[3].trim() : blockContent;
        console.log("[Callout\u8F6C\u6362] \u5904\u7406\u540E\u7684\u5185\u5BB9:", actualContent);
        const calloutInfo = { ...callout, content: actualContent };
        const { childrenIds, descendants } = this.createFeishuCalloutDescendants(calloutInfo);
        console.log("[Callout\u8F6C\u6362] \u521B\u5EFA\u7684\u5D4C\u5957Callout\u5757\u7ED3\u6784:", {
          childrenIds,
          descendants: JSON.stringify(descendants, null, 2)
        });
        if (block.block_id) {
          console.log("[Callout\u8F6C\u6362] \u6B65\u9AA41 - \u5F00\u59CB\u5220\u9664\u539F\u5F15\u7528\u5757:", {
            documentId,
            blockId: block.block_id,
            parentId: actualParentId,
            index: block.index
          });
          await this.feishuClient.deleteDocumentBlock(
            documentId,
            block.block_id,
            actualParentId,
            block.index
          );
          console.log("[Callout\u8F6C\u6362] \u6B65\u9AA41 - \u5220\u9664\u539F\u5F15\u7528\u5757\u6210\u529F");
          await new Promise((resolve) => setTimeout(resolve, 500));
        } else {
          console.warn("[Callout\u8F6C\u6362] \u8B66\u544A\uFF1A\u539F\u5757\u6CA1\u6709block_id\uFF0C\u8DF3\u8FC7\u5220\u9664\u6B65\u9AA4");
        }
        console.log("[Callout\u8F6C\u6362] \u6B65\u9AA42 - \u5F00\u59CB\u63D2\u5165\u5D4C\u5957Callout\u5757:", {
          documentId,
          parentId: actualParentId,
          index: block.index,
          childrenIds,
          descendantsCount: descendants.length
        });
        await this.feishuClient.createDocumentDescendants(
          documentId,
          actualParentId,
          block.index,
          childrenIds,
          descendants
        );
        console.log("[Callout\u8F6C\u6362] \u6B65\u9AA42 - \u63D2\u5165\u65B0Callout\u5757\u6210\u529F");
        console.log("[Callout\u8F6C\u6362] \u5355\u4E2ACallout\u8F6C\u6362\u5B8C\u6210");
        return true;
      } else {
        console.error("[Callout\u8F6C\u6362] \u9519\u8BEF\uFF1A\u7F3A\u5C11\u5FC5\u8981\u4FE1\u606F", {
          parentId: block.parent_id,
          index: block.index,
          hasParentId: !!block.parent_id,
          hasIndex: block.index !== void 0
        });
        return false;
      }
    } catch (error) {
      console.error("[Callout\u8F6C\u6362] \u5355\u4E2A\u8F6C\u6362\u5931\u8D25:", {
        documentId,
        calloutType: callout.type,
        blockId: block.block_id,
        error: error instanceof Error ? error.message : String(error)
      });
      return false;
    }
  }
  /**
   * 为文档块添加索引信息
   * @param blocks 原始文档块数组
   * @returns 添加索引后的块数组
   */
  addIndexToBlocks(blocks) {
    const blocksWithIndex = [];
    const parentChildrenMap = /* @__PURE__ */ new Map();
    for (const block of blocks) {
      if (block.parent_id) {
        if (!parentChildrenMap.has(block.parent_id)) {
          parentChildrenMap.set(block.parent_id, []);
        }
        parentChildrenMap.get(block.parent_id).push(block);
      }
    }
    for (const block of blocks) {
      const feishuBlock = {
        block_id: block.block_id,
        block_type: block.block_type,
        parent_id: block.parent_id,
        text: block.text,
        quote: block.quote,
        callout: block.callout
      };
      if (block.parent_id && parentChildrenMap.has(block.parent_id)) {
        const siblings = parentChildrenMap.get(block.parent_id);
        const index = siblings.findIndex((sibling) => sibling.block_id === block.block_id);
        feishuBlock.index = index >= 0 ? index : 0;
      } else {
        const topLevelBlocks = blocks.filter((b) => !b.parent_id);
        const index = topLevelBlocks.findIndex((b) => b.block_id === block.block_id);
        feishuBlock.index = index >= 0 ? index : 0;
      }
      blocksWithIndex.push(feishuBlock);
    }
    console.log("[Callout\u8F6C\u6362] \u7D22\u5F15\u5206\u914D\u5B8C\u6210:", {
      totalBlocks: blocksWithIndex.length,
      parentChildrenMap: Array.from(parentChildrenMap.entries()).map(([parentId, children]) => ({
        parentId,
        childrenCount: children.length
      }))
    });
    return blocksWithIndex;
  }
  /**
   * 验证 Callout 类型是否支持
   * @param type Callout 类型
   * @returns 是否支持
   */
  isSupportedCalloutType(type) {
    return type.toUpperCase() in _CalloutConverter.CALLOUT_TYPE_MAPPING;
  }
  /**
   * 获取所有支持的 Callout 类型
   * @returns 支持的类型数组
   */
  getSupportedCalloutTypes() {
    return Object.keys(_CalloutConverter.CALLOUT_TYPE_MAPPING);
  }
  /**
   * 预览 Callout 转换结果（不执行实际转换）
   * @param markdown Markdown 文本
   * @returns 转换预览信息
   */
  previewConversion(markdown) {
    const callouts = this.extractCallouts(markdown);
    const supportedCount = callouts.filter((c) => this.isSupportedCalloutType(c.type)).length;
    const unsupportedTypes = [...new Set(
      callouts.filter((c) => !this.isSupportedCalloutType(c.type)).map((c) => c.type)
    )];
    return {
      callouts,
      supportedCount,
      unsupportedTypes
    };
  }
  /**
   * 转换文档中的 Callout 为飞书高亮块
   * @param documentId 飞书文档ID
   * @param markdown Markdown 内容
   * @param selectedCalloutIndices 选中的 Callout 索引数组
   * @returns 转换结果
   */
  async convertCalloutsInDocument(documentId, markdown, selectedCalloutIndices) {
    try {
      const allCallouts = this.extractCallouts(markdown);
      if (allCallouts.length === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u672A\u627E\u5230\u4EFB\u4F55 Callout"
        };
      }
      const selectedCallouts = allCallouts.filter(
        (_, index) => selectedCalloutIndices.includes(index)
      );
      if (selectedCallouts.length === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u672A\u9009\u62E9\u4EFB\u4F55 Callout"
        };
      }
      const conversionResult = await this.feishuClient.convertMarkdownToBlocks(markdown);
      if (!(conversionResult == null ? void 0 : conversionResult.blocks)) {
        return {
          success: false,
          convertedCount: 0,
          error: "Markdown \u8F6C\u6362\u5931\u8D25"
        };
      }
      const documentBlocks = await this.feishuClient.getDocumentBlocksDetailed(documentId);
      console.log("[Callout\u8F6C\u6362] \u4ECE\u98DE\u4E66API\u83B7\u53D6\u7684\u539F\u59CB\u5757\u6570\u636E:", documentBlocks.map((b) => ({
        block_id: b.block_id,
        block_type: b.block_type,
        parent_id: b.parent_id,
        hasParentId: !!b.parent_id
      })));
      const blocksWithIndex = this.addIndexToBlocks(documentBlocks);
      console.log("[Callout\u8F6C\u6362] \u6DFB\u52A0\u7D22\u5F15\u540E\u7684\u5757\u4FE1\u606F:", blocksWithIndex.map((b) => ({
        block_id: b.block_id,
        block_type: b.block_type,
        parent_id: b.parent_id,
        index: b.index
      })));
      const matches = this.findMatchingQuoteBlocks(blocksWithIndex, selectedCallouts);
      if (matches.length === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u672A\u627E\u5230\u5339\u914D\u7684\u5F15\u7528\u5757\uFF0C\u8BF7\u786E\u4FDD\u6587\u6863\u5DF2\u540C\u6B65"
        };
      }
      let convertedCount = 0;
      for (const { callout, block } of matches) {
        console.log(`[Callout\u8F6C\u6362] \u5F00\u59CB\u5904\u7406\u7B2C ${convertedCount + 1}/${matches.length} \u4E2A\u8F6C\u6362`);
        const success = await this.processSingleCalloutConversion(
          documentId,
          callout,
          block
        );
        if (success) {
          convertedCount++;
          console.log(`[Callout\u8F6C\u6362] \u7B2C ${convertedCount} \u4E2A\u8F6C\u6362\u6210\u529F\u5B8C\u6210`);
          if (convertedCount < matches.length) {
            console.log("[Callout\u8F6C\u6362] \u7B49\u5F85\u670D\u52A1\u5668\u72B6\u6001\u540C\u6B65...");
            await new Promise((resolve) => setTimeout(resolve, 800));
          }
        } else {
          console.error(`[Callout\u8F6C\u6362] \u7B2C ${convertedCount + 1} \u4E2A\u8F6C\u6362\u5931\u8D25`);
        }
      }
      if (convertedCount === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u6240\u6709 Callout \u8F6C\u6362\u90FD\u5931\u8D25\u4E86"
        };
      }
      return {
        success: true,
        convertedCount
      };
    } catch (error) {
      console.error("[CalloutConverter] \u8F6C\u6362\u5931\u8D25:", error);
      return {
        success: false,
        convertedCount: 0,
        error: error instanceof Error ? error.message : String(error)
      };
    }
  }
};
var CalloutConverter = _CalloutConverter;
// Callout 类型映射表
CalloutConverter.CALLOUT_TYPE_MAPPING = {
  "NOTE": "LightBlueBackground",
  "INFO": "LightBlueBackground",
  "ABSTRACT": "LightBlueBackground",
  "WARNING": "LightOrangeBackground",
  "CAUTION": "LightOrangeBackground",
  "ERROR": "LightRedBackground",
  "DANGER": "LightRedBackground",
  "TIP": "LightGreenBackground",
  "HINT": "LightGreenBackground",
  "SUCCESS": "LightGreenBackground",
  "QUESTION": "LightYellowBackground",
  "HELP": "LightYellowBackground",
  "FAQ": "LightYellowBackground"
};
// 飞书API需要的数字格式背景颜色映射
CalloutConverter.CALLOUT_COLOR_NUMBER_MAPPING = {
  "NOTE": 1,
  // 蓝色
  "INFO": 1,
  // 蓝色
  "ABSTRACT": 1,
  // 蓝色
  "WARNING": 3,
  // 橙色
  "CAUTION": 3,
  // 橙色
  "ERROR": 2,
  // 红色
  "DANGER": 2,
  // 红色
  "TIP": 4,
  // 绿色
  "HINT": 4,
  // 绿色
  "SUCCESS": 4,
  // 绿色
  "QUESTION": 5,
  // 黄色
  "HELP": 5,
  // 黄色
  "FAQ": 5
  // 黄色
};
// Callout 正则表达式 - 匹配完整的 Callout 块
CalloutConverter.CALLOUT_REGEX = /^> \[!([A-Za-z]+)\][+-]?[^\n]*(?:\n((?:> .*\n?)*))?/gm;

// main.ts
var NotificationManager = class {
  constructor() {
    this.activeNotifications = /* @__PURE__ */ new Set();
    this.notificationTimeouts = /* @__PURE__ */ new Map();
  }
  /**
   * 显示通知，防止重复
   * @param message 通知消息
   * @param duration 显示时长（毫秒）
   * @param type 通知类型，用于去重
   */
  showNotice(message, duration = 4e3, type) {
    const noticeKey = type || message;
    if (this.activeNotifications.has(noticeKey)) {
      return;
    }
    this.activeNotifications.add(noticeKey);
    new import_obsidian2.Notice(message, duration);
    const timeout = setTimeout(() => {
      this.activeNotifications.delete(noticeKey);
      this.notificationTimeouts.delete(noticeKey);
    }, duration);
    this.notificationTimeouts.set(noticeKey, timeout);
  }
  /**
   * 清除所有通知状态
   */
  clearAll() {
    this.notificationTimeouts.forEach((timeout) => clearTimeout(timeout));
    this.activeNotifications.clear();
    this.notificationTimeouts.clear();
  }
};
var DEFAULT_SETTINGS = {
  appId: "",
  appSecret: "",
  folderToken: "",
  userId: "",
  uploadHistory: [],
  uploadCount: 0,
  agreedToTerms: false,
  apiCallCount: 0,
  lastResetDate: new Date().toISOString().substring(0, 7)
  // 当前年月
};
var FeishuUploaderPlugin = class extends import_obsidian2.Plugin {
  constructor() {
    super(...arguments);
    // 飞书客户端实例
    this.feishuClient = null;
    // 飞书富文本客户端实例
    this.feishuRichClient = null;
    // 通知管理器
    this.notificationManager = new NotificationManager();
    // 上次保存的敏感数据哈希，用于检测变化
    this.lastSensitiveDataHash = null;
  }
  async onload() {
    await this.loadSettings();
    if (!this.settings.agreedToTerms) {
      const termsModal = new UserAgreementModal(this.app, this);
      termsModal.open();
      return;
    }
    this.completeInitialization();
  }
  // 完成插件初始化（用户同意协议后调用）
  completeInitialization() {
    this.initializeFeishuClient();
    this.addCommand({
      id: "publish-current-document",
      name: "\u5206\u4EAB\u5F53\u524D\u6587\u6863\u5230\u98DE\u4E66",
      callback: () => {
        this.uploadCurrentDocument();
      }
    });
    this.registerEvent(
      this.app.workspace.on("file-menu", (menu, file) => {
        if (file instanceof import_obsidian2.TFile && file.extension === "md") {
          menu.addItem((item) => {
            item.setTitle("\u5206\u4EAB\u8BE5\u9875\u9762").setIcon("share").onClick(async () => {
              await this.uploadFile(file);
            });
          });
        }
      })
    );
    this.addRibbonIcon("share", "\u5206\u4EAB\u5F53\u524D\u9875\u9762", (evt) => {
      this.uploadCurrentDocument();
    });
    this.addSettingTab(new FeishuUploaderSettingTab(this.app, this));
  }
  /**
   * 初始化飞书API客户端
   */
  initializeFeishuClient() {
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u521D\u59CB\u5316\u5BA2\u6237\u7AEF\uFF0C\u5F53\u524D\u8BBE\u7F6E:", {
      appId: this.settings.appId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      appSecret: this.settings.appSecret ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      userId: this.settings.userId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      folderToken: this.settings.folderToken ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E"
    });
    if (this.settings.appId && this.settings.appSecret) {
      const asyncCallback = () => {
        this.incrementApiCallCount().catch((error) => {
          console.error("[\u98DE\u4E66\u63D2\u4EF6] API\u8C03\u7528\u8BA1\u6570\u66F4\u65B0\u5931\u8D25:", error);
        });
      };
      if (this.feishuClient) {
        this.feishuClient.updateCredentials(this.settings.appId, this.settings.appSecret);
      } else {
        this.feishuClient = createFeishuClient(this.settings.appId, this.settings.appSecret, this.app, asyncCallback);
      }
      if (this.feishuRichClient) {
        this.feishuRichClient.updateCredentials(this.settings.appId, this.settings.appSecret);
      } else {
        this.feishuRichClient = createFeishuClient(this.settings.appId, this.settings.appSecret, this.app, asyncCallback);
      }
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u6210\u529F");
    } else {
      this.feishuClient = null;
      this.feishuRichClient = null;
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u5931\u8D25\uFF1A\u7F3A\u5C11appId\u6216appSecret");
    }
  }
  onunload() {
    this.notificationManager.clearAll();
  }
  async loadSettings() {
    const loadedData = await this.loadData();
    this.settings = Object.assign({}, DEFAULT_SETTINGS, loadedData);
    const sensitiveFields = ["appId", "appSecret", "folderToken", "userId"];
    let hasPlaintextData = false;
    for (const field of sensitiveFields) {
      const value = loadedData == null ? void 0 : loadedData[field];
      if (value && typeof value === "string" && !CryptoUtils.isEncryptedData(value)) {
        hasPlaintextData = true;
        break;
      }
    }
    this.settings = await CryptoUtils.decryptSensitiveSettings(this.settings);
    const sensitiveData = sensitiveFields.map((field) => this.settings[field] || "").join("|");
    this.lastSensitiveDataHash = await this.simpleHash(sensitiveData);
    if (hasPlaintextData) {
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u68C0\u6D4B\u5230\u660E\u6587\u654F\u611F\u6570\u636E\uFF0C\u6B63\u5728\u81EA\u52A8\u52A0\u5BC6...");
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      await this.saveData(encryptedSettings);
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u660E\u6587\u6570\u636E\u5DF2\u81EA\u52A8\u52A0\u5BC6\u4FDD\u5B58");
    }
    if (this.settings.uploadHistory) {
      this.settings.uploadHistory.forEach((item) => {
        if (!item.docToken) {
          item.docToken = "\u672A\u77E5";
        }
      });
    }
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u8BBE\u7F6E\u52A0\u8F7D\u5B8C\u6210\u5E76\u89E3\u5BC6:", {
      appId: this.settings.appId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      appSecret: this.settings.appSecret ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      userId: this.settings.userId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      folderToken: this.settings.folderToken ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E"
    });
  }
  async saveSettings() {
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.initializeFeishuClient();
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u8BBE\u7F6E\u5DF2\u52A0\u5BC6\u4FDD\u5B58:", {
      appId: this.settings.appId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      appSecret: this.settings.appSecret ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      userId: this.settings.userId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      folderToken: this.settings.folderToken ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E"
    });
  }
  /**
   * 优化的保存方法：只在必要时进行加密
   */
  async saveDataOptimized() {
    const sensitiveFields = ["appId", "appSecret", "folderToken", "userId"];
    const sensitiveData = sensitiveFields.map((field) => this.settings[field] || "").join("|");
    const currentHash = await this.simpleHash(sensitiveData);
    if (this.lastSensitiveDataHash === currentHash) {
      await this.saveData(this.settings);
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u6570\u636E\u5DF2\u4FDD\u5B58\uFF08\u65E0\u9700\u91CD\u65B0\u52A0\u5BC6\uFF09");
      return;
    }
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.lastSensitiveDataHash = currentHash;
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u6570\u636E\u5DF2\u52A0\u5BC6\u4FDD\u5B58");
  }
  /**
   * 简单哈希函数
   */
  async simpleHash(data) {
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);
    const hashBuffer = await crypto.subtle.digest("SHA-256", dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
  }
  /**
   * 上传当前文档
   */
  async uploadCurrentDocument() {
    const activeView = this.app.workspace.getActiveViewOfType(import_obsidian2.MarkdownView);
    if (!activeView) {
      this.notificationManager.showNotice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2AMarkdown\u6587\u6863", 4e3, "no-markdown-doc");
      return;
    }
    const file = activeView.file;
    if (!file) {
      this.notificationManager.showNotice("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u6587\u6863", 4e3, "no-current-doc");
      return;
    }
    await this.uploadFile(file);
  }
  /**
   * 转换当前文档中的 Callout 为飞书高亮块
   */
  /**
   * 上传指定文件
   */
  async uploadFile(file) {
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5F00\u59CB\u4E0A\u4F20\u6587\u4EF6:", file.name);
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5F53\u524D\u914D\u7F6E\u72B6\u6001:", {
      feishuClient: this.feishuClient ? "\u5DF2\u521D\u59CB\u5316" : "\u672A\u521D\u59CB\u5316",
      feishuRichClient: this.feishuRichClient ? "\u5DF2\u521D\u59CB\u5316" : "\u672A\u521D\u59CB\u5316",
      appId: this.settings.appId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      appSecret: this.settings.appSecret ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      userId: this.settings.userId ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E",
      folderToken: this.settings.folderToken ? "\u5DF2\u914D\u7F6E" : "\u672A\u914D\u7F6E"
    });
    const client = this.feishuClient;
    if (!client) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25\uFF1A\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316");
      this.notificationManager.showNotice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u98DE\u4E66\u5E94\u7528\u51ED\u8BC1", 5e3, "missing-credentials");
      return;
    }
    if (!this.settings.folderToken) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25\uFF1A\u6587\u4EF6\u5939Token\u672A\u914D\u7F6E");
      this.notificationManager.showNotice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u98DE\u4E66\u6587\u4EF6\u5939Token", 5e3, "missing-folder-token");
      return;
    }
    const progressModal = new UploadProgressModal(this.app);
    progressModal.open();
    try {
      progressModal.updateProgress(10, "\u6B63\u5728\u8BFB\u53D6\u6587\u6863\u5185\u5BB9...");
      const content = await this.app.vault.read(file);
      const title = file.basename;
      progressModal.updateProgress(20, "\u6B63\u5728\u5206\u6790\u6587\u6863\u683C\u5F0F...");
      const hasImages = /!\[\[.*?\]\]/.test(content);
      let cachedCallouts = [];
      if (this.feishuClient) {
        const calloutConverter = new CalloutConverter(this.feishuClient);
        cachedCallouts = calloutConverter.extractCallouts(content);
        console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u68C0\u6D4B\u5230 ${cachedCallouts.length} \u4E2A Callout\uFF0C\u5DF2\u7F13\u5B58\u5185\u5BB9`);
      }
      console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u68C0\u6D4B\u5230${hasImages ? "\u6709" : "\u65E0"}\u56FE\u7247\uFF0C\u4F7F\u7528${hasImages ? "\u5BCC\u6587\u672C" : "\u7B80\u5355"}\u6A21\u5F0F\u4E0A\u4F20`);
      progressModal.updateProgress(30, "\u6B63\u5728\u4E0A\u4F20\u6587\u6863\u5230\u98DE\u4E66\u4E91...");
      let result;
      if (hasImages) {
        result = await this.feishuRichClient.uploadDocument(
          file.name,
          // 完整文件名（包含扩展名）用于上传到云空间
          content,
          this.settings.folderToken,
          (status) => {
            if (status.includes("\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1")) {
              progressModal.updateProgress(50, "\u6B63\u5728\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1...");
            } else if (status.includes("\u7B49\u5F85\u5904\u7406")) {
              progressModal.updateProgress(60, "\u6587\u6863\u6B63\u5728\u5904\u7406\u4E2D...");
            } else if (status.includes("\u5904\u7406\u4E2D")) {
              progressModal.updateProgress(70, "\u6B63\u5728\u8F6C\u6362\u6587\u6863\u683C\u5F0F...");
            }
          }
        );
      } else {
        result = await this.feishuClient.uploadDocument(
          file.name,
          // 完整文件名（包含扩展名）用于上传到云空间
          content,
          this.settings.folderToken,
          (status) => {
            if (status.includes("\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1")) {
              progressModal.updateProgress(50, "\u6B63\u5728\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1...");
            } else if (status.includes("\u7B49\u5F85\u5904\u7406")) {
              progressModal.updateProgress(60, "\u6587\u6863\u6B63\u5728\u5904\u7406\u4E2D...");
            } else if (status.includes("\u5904\u7406\u4E2D")) {
              progressModal.updateProgress(70, "\u6B63\u5728\u8F6C\u6362\u6587\u6863\u683C\u5F0F...");
            }
          }
        );
      }
      if (cachedCallouts.length > 0) {
        progressModal.updateProgress(80, "\u6B63\u5728\u5904\u7406\u6807\u6CE8\u5757...");
        await this.autoConvertCallouts(result.token, cachedCallouts);
      }
      progressModal.complete();
      await this.addUploadHistory(title, result.url, result.token);
      new DocumentPermissionModal(this.app, result.token, result.url, title, this, false).open();
    } catch (error) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25:", error);
      let userMessage = "";
      const errorMessage = error instanceof Error ? error.message : String(error);
      if (errorMessage.includes("\u5BFC\u5165\u4EFB\u52A1\u5904\u7406\u8D85\u65F6")) {
        userMessage = "\u6587\u6863\u5904\u7406\u65F6\u95F4\u8F83\u957F\uFF0C\u8BF7\u7A0D\u540E\u624B\u52A8\u68C0\u67E5\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u7684\u65B0\u6587\u6863\u3002";
        progressModal.complete();
        new import_obsidian2.Notice(userMessage, 1e4);
        return;
      } else if (errorMessage.includes("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25")) {
        userMessage = "\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u4EE5\u4E0B\u9879\u76EE\uFF1A\n1. \u786E\u4FDD\u7F51\u7EDC\u8FDE\u63A5\u6B63\u5E38\n2. \u68C0\u67E5\u9632\u706B\u5899\u8BBE\u7F6E\n3. \u5C1D\u8BD5\u91CD\u65B0\u8FDE\u63A5\u7F51\u7EDC\u540E\u91CD\u8BD5";
      } else if (errorMessage.includes("\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25")) {
        userMessage = "API\u8BA4\u8BC1\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\uFF1A\n1. App ID \u548C App Secret \u662F\u5426\u6B63\u786E\n2. \u5E94\u7528\u6743\u9650\u662F\u5426\u914D\u7F6E\u6B63\u786E\n3. \u7F51\u7EDC\u662F\u5426\u80FD\u8BBF\u95EE\u98DE\u4E66API";
      } else if (errorMessage.includes("\u6587\u4EF6\u5939")) {
        userMessage = "\u6587\u4EF6\u5939\u914D\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\uFF1A\n1. \u6587\u4EF6\u5939Token\u662F\u5426\u6B63\u786E\n2. \u662F\u5426\u6709\u6587\u4EF6\u5939\u5199\u5165\u6743\u9650";
      } else if (errorMessage.includes("\u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF0C\u5DF2\u91CD\u8BD5")) {
        userMessage = "\u67E5\u8BE2\u5BFC\u5165\u72B6\u6001\u5931\u8D25\uFF0C\u5DF2\u91CD\u8BD52\u6B21\u3002\u6587\u6863\u53EF\u80FD\u5DF2\u6210\u529F\u4E0A\u4F20\uFF0C\u8BF7\u624B\u52A8\u68C0\u67E5\u98DE\u4E66\u4E91\u6587\u6863\u3002";
      } else {
        userMessage = `\u4E0A\u4F20\u5931\u8D25: ${errorMessage}`;
      }
      progressModal.showError(userMessage);
      new import_obsidian2.Notice(userMessage, 8e3);
      if (errorMessage.includes("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25")) {
        this.showRetryDialog(file);
      }
    }
  }
  /**
   * 自动转换文档中的 Callout（无用户交互）
   * 在图片处理完成后调用，此时文档已完全同步
   * @param docToken 文档Token
   * @param cachedCallouts 预先缓存的Callout数组
   */
  async autoConvertCallouts(docToken, cachedCallouts) {
    try {
      if (!this.feishuClient) {
        console.warn("[\u98DE\u4E66\u63D2\u4EF6] \u98DE\u4E66\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316\uFF0C\u8DF3\u8FC7 Callout \u8F6C\u6362");
        return;
      }
      if (cachedCallouts.length > 0) {
        console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u4F7F\u7528\u7F13\u5B58\u7684 ${cachedCallouts.length} \u4E2A Callout\uFF0C\u5F00\u59CB\u81EA\u52A8\u8F6C\u6362`);
        console.log("[\u98DE\u4E66\u63D2\u4EF6] \u7F13\u5B58\u7684 Callouts:", cachedCallouts);
        const calloutConverter = new CalloutConverter(this.feishuClient);
        await new Promise((resolve) => setTimeout(resolve, 1e3));
        const documentBlocks = await this.feishuClient.getDocumentBlocksDetailed(docToken);
        if (!documentBlocks || documentBlocks.length === 0) {
          console.warn("[\u98DE\u4E66\u63D2\u4EF6] \u65E0\u6CD5\u83B7\u53D6\u6587\u6863\u5757\u4FE1\u606F\uFF0C\u8DF3\u8FC7 Callout \u8F6C\u6362");
          return;
        }
        console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u83B7\u53D6\u5230 ${documentBlocks.length} \u4E2A\u6587\u6863\u5757`);
        const blocksWithIndex = calloutConverter.addIndexToBlocks(documentBlocks);
        console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u5DF2\u4E3A ${blocksWithIndex.length} \u4E2A\u6587\u6863\u5757\u6DFB\u52A0\u7D22\u5F15\u4FE1\u606F`);
        const quoteBlocks = blocksWithIndex.filter((block) => block.block_type === 15);
        console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u627E\u5230 ${quoteBlocks.length} \u4E2A\u5F15\u7528\u5757 (type=15):`, quoteBlocks);
        const blockTypes = blocksWithIndex.reduce((acc, block) => {
          acc[block.block_type] = (acc[block.block_type] || 0) + 1;
          return acc;
        }, {});
        console.log("[\u98DE\u4E66\u63D2\u4EF6] \u6587\u6863\u5757\u7C7B\u578B\u7EDF\u8BA1:", blockTypes);
        const matches = calloutConverter.findMatchingQuoteBlocks(blocksWithIndex, cachedCallouts);
        if (matches.length === 0) {
          console.log("[\u98DE\u4E66\u63D2\u4EF6] \u672A\u627E\u5230\u5339\u914D\u7684\u5F15\u7528\u5757\uFF0C\u53EF\u80FD\u6587\u6863\u4E2D\u6CA1\u6709\u5BF9\u5E94\u7684 Callout \u5F15\u7528\u5757");
          return;
        }
        let convertedCount = 0;
        for (const { callout, block } of matches) {
          const success = await calloutConverter.processSingleCalloutConversion(
            docToken,
            callout,
            block
          );
          if (success) {
            convertedCount++;
          }
        }
        console.log(`[\u98DE\u4E66\u63D2\u4EF6] \u6210\u529F\u8F6C\u6362 ${convertedCount} \u4E2A Callout`);
      } else {
        console.log("[\u98DE\u4E66\u63D2\u4EF6] \u7F13\u5B58\u4E2D\u65E0 Callout\uFF0C\u8DF3\u8FC7\u8F6C\u6362");
      }
    } catch (error) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] Callout \u81EA\u52A8\u8F6C\u6362\u51FA\u9519:", error);
    }
  }
  /**
   * 显示重试对话框
   */
  showRetryDialog(file) {
    const modal = new RetryModal(this.app, () => {
      this.uploadFile(file);
    });
    modal.open();
  }
  /**
   * 添加上传历史记录
   */
  async addUploadHistory(title, url, docToken, permissions) {
    const now = new Date();
    const uploadTime = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0") + "-" + String(now.getDate()).padStart(2, "0") + " " + String(now.getHours()).padStart(2, "0") + ":" + String(now.getMinutes()).padStart(2, "0");
    const historyItem = {
      title,
      url,
      uploadTime,
      docToken,
      ...permissions && { permissions }
    };
    this.settings.uploadHistory.unshift(historyItem);
    this.settings.uploadCount++;
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    this.saveData(encryptedSettings);
  }
  /**
   * 更新历史记录中的权限设置
   */
  async updateHistoryPermissions(docToken, permissions) {
    const historyItem = this.settings.uploadHistory.find((item) => item.docToken === docToken);
    if (historyItem) {
      historyItem.permissions = permissions;
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      this.saveData(encryptedSettings);
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5386\u53F2\u8BB0\u5F55\u6743\u9650\u5DF2\u66F4\u65B0:", { docToken, permissions });
    }
  }
  /**
   * 删除单个历史记录项
   * @param docToken 文档token
   */
  async deleteHistoryItem(docToken) {
    const index = this.settings.uploadHistory.findIndex((item) => item.docToken === docToken);
    if (index !== -1) {
      this.settings.uploadHistory.splice(index, 1);
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      this.saveData(encryptedSettings);
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5386\u53F2\u8BB0\u5F55\u9879\u5DF2\u5220\u9664:", { docToken });
    }
  }
  /**
   * 删除文件并清除历史记录
   * @param docToken 文档token
   * @param title 文档标题
   */
  async deleteFileAndHistory(docToken, title) {
    if (!this.feishuClient) {
      throw new Error("\u98DE\u4E66\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316");
    }
    try {
      await this.feishuClient.deleteFile(docToken);
      await this.incrementApiCallCount();
      await this.deleteHistoryItem(docToken);
      this.notificationManager.showNotice(`\u6587\u4EF6 "${title}" \u5DF2\u5220\u9664`, 3e3);
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u6587\u4EF6\u548C\u5386\u53F2\u8BB0\u5F55\u5220\u9664\u6210\u529F:", { docToken, title });
    } catch (error) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u5220\u9664\u6587\u4EF6\u5931\u8D25:", error);
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 清空上传历史记录
   */
  async clearUploadHistory() {
    this.settings.uploadHistory = [];
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    this.saveData(encryptedSettings);
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5DF2\u6E05\u7A7A\u4E0A\u4F20\u5386\u53F2\u8BB0\u5F55");
    this.notificationManager.showNotice("\u5DF2\u6E05\u7A7A\u4E0A\u4F20\u5386\u53F2\u8BB0\u5F55", 3e3, "history-cleared");
  }
  /**
   * 重置上传次数
   */
  async resetUploadCount() {
    this.settings.uploadCount = 0;
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    this.saveData(encryptedSettings);
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5DF2\u91CD\u7F6E\u4E0A\u4F20\u6B21\u6570");
    this.notificationManager.showNotice("\u5DF2\u91CD\u7F6E\u4E0A\u4F20\u6B21\u6570", 3e3, "count-reset");
  }
  /**
   * 增加API调用次数
   */
  async incrementApiCallCount() {
    var _a;
    await this.checkAndResetApiCount();
    this.settings.apiCallCount++;
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    this.saveData(encryptedSettings);
    const stack = new Error().stack;
    const callerLine = ((_a = stack == null ? void 0 : stack.split("\n")[2]) == null ? void 0 : _a.trim()) || "\u672A\u77E5\u8C03\u7528\u8005";
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u{1F522} API\u8C03\u7528\u6B21\u6570\u5DF2\u589E\u52A0\uFF0C\u5F53\u524D:", this.settings.apiCallCount, "\u8C03\u7528\u8005:", callerLine);
  }
  /**
   * 检查并重置API调用次数（每月1日北京时间自动重置）
   */
  async checkAndResetApiCount() {
    const now = new Date();
    const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1e3);
    const currentMonth = beijingTime.toISOString().substring(0, 7);
    if (this.settings.lastResetDate !== currentMonth) {
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u68C0\u6D4B\u5230\u65B0\u6708\u4EFD\uFF0C\u81EA\u52A8\u91CD\u7F6EAPI\u8C03\u7528\u6B21\u6570");
      this.settings.apiCallCount = 0;
      this.settings.lastResetDate = currentMonth;
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      this.saveData(encryptedSettings);
    }
  }
  /**
   * 手动重置API调用次数
   */
  async resetApiCallCount() {
    this.settings.apiCallCount = 0;
    const now = new Date();
    const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1e3);
    this.settings.lastResetDate = beijingTime.toISOString().substring(0, 7);
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    this.saveData(encryptedSettings);
    console.log("[\u98DE\u4E66\u63D2\u4EF6] \u{1F504} \u5DF2\u624B\u52A8\u91CD\u7F6EAPI\u8C03\u7528\u6B21\u6570\uFF0C\u5F53\u524D\u8BA1\u6570:", this.settings.apiCallCount);
    this.notificationManager.showNotice("\u5DF2\u91CD\u7F6EAPI\u8C03\u7528\u6B21\u6570", 3e3, "api-count-reset");
  }
  /**
   * 测试网络连接
   */
  async testNetworkConnection() {
    try {
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u5F00\u59CB\u6D4B\u8BD5\u7F51\u7EDC\u8FDE\u63A5");
      if (!this.feishuClient) {
        console.error("[\u98DE\u4E66\u63D2\u4EF6] \u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316\uFF0C\u65E0\u6CD5\u6D4B\u8BD5\u8FDE\u63A5");
        return false;
      }
      const result = await this.feishuClient.testConnection();
      this.incrementApiCallCount();
      console.log("[\u98DE\u4E66\u63D2\u4EF6] \u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u7ED3\u679C:", result);
      return result;
    } catch (error) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25:", error);
      return false;
    }
  }
};
var DocumentPermissionModal = class extends import_obsidian2.Modal {
  // 标识是否允许关闭
  constructor(app, docToken, docUrl, title, plugin, isFromSettings = false) {
    super(app);
    // 标识是否从设置页面调用
    this.allowClose = false;
    this.docToken = docToken;
    this.docUrl = docUrl;
    this.title = title;
    this.plugin = plugin;
    this.isFromSettings = isFromSettings;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("feishu-permission-modal");
    contentEl.createEl("h2", { text: "\u8BBE\u7F6E\u6587\u6863\u6743\u9650" });
    contentEl.createEl("p", { text: `\u4E3A\u6587\u6863 "${this.title}" \u8BBE\u7F6E\u8BBF\u95EE\u6743\u9650` });
    const permissionContainer = contentEl.createDiv("permission-options");
    const publicOption = permissionContainer.createDiv("permission-option");
    const publicCheckbox = publicOption.createEl("input", { type: "checkbox" });
    publicCheckbox.id = "isPublic";
    publicCheckbox.style.marginBottom = "8px";
    const publicLabel = publicOption.createEl("label", { text: "\u662F\u5426\u516C\u5F00\u6587\u6863\uFF1F", attr: { for: "isPublic" } });
    publicLabel.createEl("div", { text: "\u82E5\u60A8\u5F00\u542F\uFF0C\u60A8\u9700\u8981\u9075\u5B88\u98DE\u4E66\u7684\u76F8\u5173\u534F\u8BAE\uFF0C\u60A8\u4F5C\u4E3A\u6587\u6863\u6240\u6709\u8005\uFF0C\u9700\u5BF9\u5176\u5408\u6CD5\u5408\u89C4\u6027\u8D1F\u8D23\uFF0C\u4EFB\u4F55\u7531\u6B64\u4EA7\u751F\u7684\u7EA0\u7EB7\u4E0E\u672C\u63D2\u4EF6\u65E0\u5173\u3002", cls: "option-desc" });
    const copyOption = permissionContainer.createDiv("permission-option");
    const copyCheckbox = copyOption.createEl("input", { type: "checkbox" });
    copyCheckbox.id = "allowCopy";
    copyCheckbox.style.marginBottom = "8px";
    copyCheckbox.disabled = true;
    const copyLabel = copyOption.createEl("label", { text: "\u662F\u5426\u5141\u8BB8\u590D\u5236\uFF1F", attr: { for: "allowCopy" } });
    copyLabel.createEl("div", { text: "\u5141\u8BB8\u7528\u6237\u590D\u5236\u6587\u6863\u5185\u5BB9", cls: "option-desc" });
    const copyCreateOption = permissionContainer.createDiv("permission-option");
    const copyCreateCheckbox = copyCreateOption.createEl("input", { type: "checkbox" });
    copyCreateCheckbox.id = "allowCreateCopy";
    copyCreateCheckbox.style.marginBottom = "8px";
    copyCreateCheckbox.disabled = true;
    const copyCreateLabel = copyCreateOption.createEl("label", { text: "\u662F\u5426\u5141\u8BB8\u521B\u5EFA\u526F\u672C\u3001\u6253\u5370\u3001\u4E0B\u8F7D\uFF1F", attr: { for: "allowCreateCopy" } });
    copyCreateLabel.createEl("div", { text: "\u5141\u8BB8\u7528\u6237\u521B\u5EFA\u6587\u6863\u526F\u672C\u3001\u6253\u5370\u548C\u4E0B\u8F7D\u6587\u6863", cls: "option-desc" });
    const currentPermissions = this.getCurrentPermissions();
    if (currentPermissions) {
      publicCheckbox.checked = currentPermissions.isPublic;
      copyCheckbox.checked = currentPermissions.allowCopy;
      copyCreateCheckbox.checked = currentPermissions.allowCreateCopy;
    }
    const updateOptionStates = () => {
      const isPublic = publicCheckbox.checked;
      copyCheckbox.disabled = !isPublic;
      copyCreateCheckbox.disabled = !isPublic;
      if (!isPublic) {
        copyCheckbox.checked = false;
        copyCreateCheckbox.checked = false;
      }
      copyOption.style.opacity = isPublic ? "1" : "0.5";
      copyCreateOption.style.opacity = isPublic ? "1" : "0.5";
      copyOption.style.pointerEvents = isPublic ? "auto" : "none";
      copyCreateOption.style.pointerEvents = isPublic ? "auto" : "none";
    };
    publicOption.onclick = () => {
      publicCheckbox.checked = !publicCheckbox.checked;
      updateOptionStates();
    };
    copyOption.onclick = () => {
      if (!copyCheckbox.disabled) {
        copyCheckbox.checked = !copyCheckbox.checked;
      }
    };
    copyCreateOption.onclick = () => {
      if (!copyCreateCheckbox.disabled) {
        copyCreateCheckbox.checked = !copyCreateCheckbox.checked;
      }
    };
    publicCheckbox.onclick = (e) => {
      e.stopPropagation();
      updateOptionStates();
    };
    copyCheckbox.onclick = (e) => {
      e.stopPropagation();
    };
    copyCreateCheckbox.onclick = (e) => {
      e.stopPropagation();
    };
    updateOptionStates();
    const buttonContainer = contentEl.createDiv("modal-button-container");
    const submitButton = buttonContainer.createEl("button", { text: "\u63D0\u4EA4\u8BBE\u7F6E", cls: "mod-cta" });
    submitButton.onclick = async () => {
      const isPublic = publicCheckbox.checked;
      const allowCopy = copyCheckbox.checked;
      const allowCreateCopy = copyCreateCheckbox.checked;
      const permissions = {
        isPublic,
        allowCopy,
        allowCreateCopy,
        allowPrintDownload: allowCreateCopy,
        // 新增参数：根据用户选择设置特殊权限
        copyEntity: allowCopy ? "anyone_can_view" : "only_full_access",
        securityEntity: allowCreateCopy ? "anyone_can_view" : "only_full_access"
      };
      submitButton.disabled = true;
      submitButton.textContent = "\u8BBE\u7F6E\u4E2D...";
      try {
        if (!this.plugin.settings.userId) {
          throw new Error("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u60A8\u7684\u98DE\u4E66\u7528\u6237ID");
        }
        console.log("[\u98DE\u4E66\u63D2\u4EF6] \u4F7F\u7528\u914D\u7F6E\u7684\u7528\u6237ID:", this.plugin.settings.userId);
        if (this.isFromSettings) {
          await this.plugin.feishuClient.updateDocumentPermissionsOnly(this.docToken, permissions);
        } else {
          await this.plugin.feishuClient.setDocumentPermissions(this.docToken, permissions, this.plugin.settings.userId);
        }
        const permissionsToSave = {
          isPublic,
          allowCopy,
          allowCreateCopy
        };
        this.forceClose();
        if (!this.isFromSettings) {
          this.plugin.updateHistoryPermissions(this.docToken, permissionsToSave);
          new UploadResultModal(this.app, this.docUrl, this.title).open();
        } else {
          this.plugin.updateHistoryPermissions(this.docToken, permissionsToSave);
          this.plugin.notificationManager.showNotice("\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u6210\u529F", 3e3);
        }
      } catch (error) {
        console.error("[\u98DE\u4E66\u63D2\u4EF6] \u6743\u9650\u8BBE\u7F6E\u5931\u8D25:", error);
        const errorMessage = error instanceof Error ? error.message : String(error);
        this.plugin.notificationManager.showNotice(`\u6743\u9650\u8BBE\u7F6E\u5931\u8D25: ${errorMessage}`, 5e3, "permission-error");
        submitButton.disabled = false;
        submitButton.textContent = "\u63D0\u4EA4\u8BBE\u7F6E";
      }
    };
  }
  onClose() {
    if (this.isFromSettings || this.allowClose) {
      const { contentEl } = this;
      contentEl.empty();
      super.onClose();
    }
  }
  // 获取当前权限设置
  getCurrentPermissions() {
    const historyItem = this.plugin.settings.uploadHistory.find((item) => item.docToken === this.docToken);
    return (historyItem == null ? void 0 : historyItem.permissions) || null;
  }
  // 添加强制关闭方法，仅在权限设置成功后调用
  forceClose() {
    this.allowClose = true;
    this.close();
  }
  /**
   * 检测并转换 Callout
   */
};
var UploadResultModal = class extends import_obsidian2.Modal {
  constructor(app, url, title) {
    super(app);
    this.url = url;
    this.title = title;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("feishu-success-modal");
    contentEl.createEl("h2", { text: "\u4E0A\u4F20\u6210\u529F\uFF01" });
    contentEl.createEl("p", { text: `\u6587\u6863 "${this.title}" \u5DF2\u6210\u529F\u4E0A\u4F20\u5230\u98DE\u4E66\u4E91\u6587\u6863` });
    const linkEl = contentEl.createEl("a", {
      text: this.url,
      href: this.url
    });
    linkEl.setAttribute("target", "_blank");
    const buttonContainer = contentEl.createDiv("modal-button-container");
    const copyButton = buttonContainer.createEl("button", { text: "\u590D\u5236\u94FE\u63A5" });
    copyButton.onclick = () => {
      navigator.clipboard.writeText(this.url);
      new import_obsidian2.Notice("\u94FE\u63A5\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F");
    };
    const openButton = buttonContainer.createEl("button", { text: "\u6253\u5F00\u6587\u6863" });
    openButton.onclick = () => {
      window.open(this.url, "_blank");
    };
    const closeButton = buttonContainer.createEl("button", { text: "\u5173\u95ED" });
    closeButton.onclick = () => {
      this.close();
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
var RetryModal = class extends import_obsidian2.Modal {
  constructor(app, onRetry) {
    super(app);
    this.onRetry = onRetry;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.createEl("h2", { text: "\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25" });
    const descEl = contentEl.createEl("div", { cls: "retry-modal-desc" });
    descEl.createEl("p", { text: "\u4E0A\u4F20\u5931\u8D25\uFF0C\u53EF\u80FD\u662F\u7F51\u7EDC\u8FDE\u63A5\u95EE\u9898\u3002" });
    descEl.createEl("p", { text: "\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5\uFF0C\u6216\u7A0D\u540E\u518D\u8BD5\u3002" });
    const buttonContainer = contentEl.createEl("div", { cls: "retry-modal-buttons" });
    buttonContainer.style.display = "flex";
    buttonContainer.style.gap = "10px";
    buttonContainer.style.justifyContent = "flex-end";
    buttonContainer.style.marginTop = "20px";
    const cancelBtn = buttonContainer.createEl("button", { text: "\u53D6\u6D88" });
    cancelBtn.onclick = () => {
      this.close();
    };
    const retryBtn = buttonContainer.createEl("button", { text: "\u91CD\u8BD5", cls: "mod-cta" });
    retryBtn.onclick = () => {
      this.close();
      this.onRetry();
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
var FeishuUploaderSettingTab = class extends import_obsidian2.PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
  display() {
    const { containerEl } = this;
    containerEl.empty();
    containerEl.createEl("h1", { text: "\u57FA\u7840\u8BBE\u7F6E" });
    const descEl = containerEl.createDiv();
    descEl.createEl("p", { text: "\u4F60\u9700\u8981\u914D\u7F6E\u98DE\u4E66\u5E94\u7528App ID\u3001App secret\u3001\u60A8\u7684\u98DE\u4E66\u7528\u6237ID\u3001\u60A8\u7684\u6587\u4EF6\u5939token\u624D\u80FD\u6B63\u5E38\u542F\u52A8\u6B64\u63D2\u4EF6" });
    descEl.createEl("p").innerHTML = '\u5B8C\u6210\u914D\u7F6E\u9884\u8BA1\u9700\u89815-10\u5206\u949F\uFF0C\u8BF7\u53C2\u9605\uFF1A<a href="https://itlueqqx8t.feishu.cn/docx/XUJmdxbf7octOFx3Vt0c3KJ3nWe" target="_blank">\u5FEB\u901F\u914D\u7F6E\u60A8\u7684ObShare</a>';
    const appIdSetting = new import_obsidian2.Setting(containerEl).setName("App ID").setDesc("\u98DE\u4E66\u5E94\u7528\u7684App ID").addText((text) => text.setPlaceholder("\u8F93\u5165App ID").setValue(this.plugin.settings.appId).onChange(async (value) => {
      this.plugin.settings.appId = value;
      await this.plugin.saveSettings();
    }));
    appIdSetting.nameEl.innerHTML = 'App ID <span style="color: red;">*</span>';
    const appSecretSetting = new import_obsidian2.Setting(containerEl).setName("App Secret").setDesc("\u98DE\u4E66\u5E94\u7528\u7684App Secret").addText((text) => text.setPlaceholder("\u8F93\u5165App Secret").setValue(this.plugin.settings.appSecret).onChange(async (value) => {
      this.plugin.settings.appSecret = value;
      await this.plugin.saveSettings();
    }));
    appSecretSetting.nameEl.innerHTML = 'App Secret <span style="color: red;">*</span>';
    const userIdSetting = new import_obsidian2.Setting(containerEl).setName("\u7528\u6237ID").setDesc("\u60A8\u7684\u98DE\u4E66\u7528\u6237ID").addText((text) => text.setPlaceholder("\u8F93\u5165\u60A8\u7684\u98DE\u4E66\u7528\u6237ID").setValue(this.plugin.settings.userId).onChange(async (value) => {
      this.plugin.settings.userId = value;
      await this.plugin.saveSettings();
    }));
    userIdSetting.nameEl.innerHTML = '\u7528\u6237ID <span style="color: red;">*</span>';
    const folderTokenSetting = new import_obsidian2.Setting(containerEl).setName("\u6587\u4EF6\u5939Token").setDesc("\u98DE\u4E66\u4E91\u7A7A\u95F4\u6587\u4EF6\u5939\u7684Token\uFF0C\u6587\u6863\u5C06\u4E0A\u4F20\u5230\u6B64\u6587\u4EF6\u5939").addText((text) => text.setPlaceholder("\u8F93\u5165\u6587\u4EF6\u5939Token").setValue(this.plugin.settings.folderToken).onChange(async (value) => {
      this.plugin.settings.folderToken = value;
      await this.plugin.saveSettings();
    }));
    folderTokenSetting.nameEl.innerHTML = '\u6587\u4EF6\u5939Token <span style="color: red;">*</span>';
    new import_obsidian2.Setting(containerEl).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u98DE\u4E66API\u8FDE\u63A5\u662F\u5426\u6B63\u5E38").addButton((button) => button.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async () => {
      if (!this.plugin.feishuClient) {
        this.plugin.notificationManager.showNotice("\u8BF7\u5148\u914D\u7F6EApp ID\u548CApp Secret", 4e3, "missing-config");
        return;
      }
      try {
        button.setButtonText("\u6D4B\u8BD5\u4E2D...");
        const success = await this.plugin.testNetworkConnection();
        if (success) {
          this.plugin.notificationManager.showNotice("\u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F\uFF01", 3e3, "test-success");
        } else {
          new import_obsidian2.Notice("\u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u548C\u914D\u7F6E");
        }
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        if (errorMessage.includes("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25")) {
          new import_obsidian2.Notice("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5");
        } else {
          new import_obsidian2.Notice(`\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: ${errorMessage}`);
        }
      } finally {
        button.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5");
      }
    }));
    containerEl.createEl("h1", { text: "\u6570\u636E\u7EDF\u8BA1" });
    new import_obsidian2.Setting(containerEl).setName("\u5206\u4EAB\u6587\u6863\u6570").setDesc(`\u60A8\u5DF2\u6210\u529F\u5206\u4EAB ${this.plugin.settings.uploadCount} \u4E2A\u6587\u6863`).addButton((button) => button.setButtonText("\u91CD\u7F6E\u8BA1\u6570").setWarning().onClick(() => {
      this.plugin.resetUploadCount();
      this.display();
    }));
    const currentMonth = new Date().toISOString().substring(0, 7);
    const isCurrentMonth = this.plugin.settings.lastResetDate === currentMonth;
    const displayCount = isCurrentMonth ? this.plugin.settings.apiCallCount : 0;
    new import_obsidian2.Setting(containerEl).setName("\u672C\u6708API\u8C03\u7528\u6B21\u6570").setDesc(`\u672C\u6708\u5DF2\u8C03\u7528\u98DE\u4E66API ${displayCount} \u6B21`).addButton((button) => button.setButtonText("\u91CD\u7F6E\u8BA1\u6570").setWarning().onClick(() => {
      this.plugin.resetApiCallCount();
      this.display();
    }));
    containerEl.createEl("h1", { text: "\u5206\u4EAB\u7BA1\u7406" });
    if (this.plugin.settings.uploadHistory.length === 0) {
      containerEl.createEl("p", { text: "\u6682\u65E0\u4E0A\u4F20\u8BB0\u5F55", cls: "upload-history-empty" });
    } else {
      new import_obsidian2.Setting(containerEl).setName("\u6E05\u7A7A\u5386\u53F2\u8BB0\u5F55").setDesc("\u5206\u4EAB\u5386\u53F2\u8BB0\u5F55").addButton((button) => button.setButtonText("\u6E05\u7A7A").setWarning().onClick(() => {
        this.plugin.clearUploadHistory();
        this.display();
      }));
      const historyContainer = containerEl.createDiv("upload-history-container");
      this.plugin.settings.uploadHistory.forEach((item, index) => {
        const historyItem = historyContainer.createDiv("upload-history-item");
        const headerEl = historyItem.createDiv("upload-history-header");
        const titleEl = headerEl.createEl("div", {
          text: item.title,
          cls: "upload-history-title"
        });
        const timeEl = headerEl.createEl("div", {
          text: item.uploadTime,
          cls: "upload-history-time"
        });
        const linkRowEl = historyItem.createDiv("upload-history-link-row");
        const linkEl = linkRowEl.createEl("a", {
          text: item.url,
          href: item.url,
          cls: "upload-history-link"
        });
        linkEl.setAttribute("target", "_blank");
        const copyIcon = linkRowEl.createEl("span", {
          text: "\u{1F4CB}",
          cls: "upload-history-copy-icon"
        });
        copyIcon.onclick = () => {
          navigator.clipboard.writeText(item.url);
          new import_obsidian2.Notice("\u94FE\u63A5\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F");
        };
        const permissionIcon = linkRowEl.createEl("span", {
          text: "\u2699\uFE0F",
          cls: "upload-history-copy-icon"
        });
        permissionIcon.onclick = () => {
          const permissionModal = new DocumentPermissionModal(
            this.app,
            item.docToken,
            item.url,
            item.title,
            this.plugin,
            true
            // isFromSettings = true
          );
          permissionModal.open();
        };
        const deleteIcon = linkRowEl.createEl("span", {
          text: "\u{1F5D1}\uFE0F",
          cls: "upload-history-copy-icon"
        });
        deleteIcon.onclick = async () => {
          const confirmed = confirm(`\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6 "${item.title}" \u5417\uFF1F

\u6CE8\u610F\uFF1A\u6B64\u64CD\u4F5C\u5C06\u5220\u9664\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u7684\u6587\u4EF6\uFF01`);
          if (!confirmed) {
            return;
          }
          await this.plugin.deleteHistoryItem(item.docToken);
          this.display();
          try {
            if (this.plugin.feishuClient) {
              await this.plugin.feishuClient.deleteFile(item.docToken);
              await this.plugin.incrementApiCallCount();
              console.log("[\u8BBE\u7F6E\u9875\u9762] \u6587\u4EF6\u5220\u9664\u6210\u529F:", { docToken: item.docToken, title: item.title });
            }
          } catch (error) {
            console.error("[\u8BBE\u7F6E\u9875\u9762] API\u5220\u9664\u6587\u4EF6\u5931\u8D25:", error);
            if (error instanceof Error && (error.message.includes("404") || error.message.includes("not found"))) {
              this.plugin.notificationManager.showNotice(
                "\u5220\u9664\u5931\u8D25\uFF0C\u8BF7\u60A8\u5728\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u81EA\u884C\u5C1D\u8BD5\u5220\u9664\u3002",
                5e3
              );
            } else {
              this.plugin.notificationManager.showNotice(
                "\u5220\u9664\u5931\u8D25\uFF0C\u8BF7\u60A8\u5728\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u81EA\u884C\u5C1D\u8BD5\u5220\u9664\u3002",
                5e3
              );
            }
          }
        };
      });
    }
  }
};
var UploadProgressModal = class extends import_obsidian2.Modal {
  // 伪进度最大值
  constructor(app) {
    super(app);
    this.currentProgress = 0;
    this.currentStep = "";
    this.isCompleted = false;
    this.fakeProgressTimer = null;
    this.lastRealProgress = 0;
    this.maxFakeProgress = 85;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("feishu-upload-progress-modal");
    contentEl.style.cssText = `
			padding: 30px;
			text-align: center;
			min-width: 400px;
			border-radius: 8px;
		`;
    const title = contentEl.createEl("h2", { text: "\u6B63\u5728\u4E0A\u4F20\u6587\u6863" });
    title.style.cssText = `
			margin-bottom: 20px;
			color: var(--text-normal);
			font-size: 18px;
		`;
    this.stepText = contentEl.createEl("div", { text: "\u51C6\u5907\u4E0A\u4F20..." });
    this.stepText.style.cssText = `
			margin-bottom: 20px;
			color: var(--text-muted);
			font-size: 14px;
		`;
    const progressContainer = contentEl.createDiv("progress-container");
    progressContainer.style.cssText = `
			width: 100%;
			height: 8px;
			background: var(--background-modifier-border);
			border-radius: 4px;
			overflow: hidden;
			margin-bottom: 15px;
		`;
    this.progressBar = progressContainer.createDiv("progress-bar");
    this.progressBar.style.cssText = `
			height: 100%;
			background: linear-gradient(90deg, var(--interactive-accent), var(--interactive-accent-hover));
			width: 0%;
			transition: width 0.3s ease;
			border-radius: 4px;
		`;
    this.progressText = contentEl.createEl("div", { text: "0%" });
    this.progressText.style.cssText = `
			color: var(--text-muted);
			font-size: 12px;
			margin-bottom: 20px;
		`;
    const hintText = contentEl.createEl("div", { text: "\u8BF7\u4FDD\u6301\u7F51\u7EDC\u8FDE\u63A5\uFF0C\u4E0D\u8981\u5173\u95ED\u6B64\u7A97\u53E3" });
    hintText.style.cssText = `
			color: var(--text-muted);
			font-size: 12px;
			font-style: italic;
		`;
    this.startFakeProgress();
  }
  /**
   * 更新进度
   * @param progress 进度百分比 (0-100)
   * @param step 当前步骤描述
   */
  updateProgress(progress, step) {
    const targetProgress = Math.min(100, Math.max(0, progress));
    if (targetProgress > this.lastRealProgress) {
      this.lastRealProgress = targetProgress;
      this.stopFakeProgress();
      this.setProgress(targetProgress);
      if (targetProgress < this.maxFakeProgress && !this.isCompleted) {
        this.startFakeProgress();
      }
    }
    this.currentStep = step;
    if (this.stepText) {
      this.stepText.textContent = step;
    }
  }
  /**
   * 设置进度条显示
   * @param progress 进度百分比
   */
  setProgress(progress) {
    this.currentProgress = progress;
    if (this.progressBar) {
      this.progressBar.style.width = `${this.currentProgress}%`;
    }
    if (this.progressText) {
      this.progressText.textContent = `${Math.round(this.currentProgress)}%`;
    }
  }
  /**
   * 启动伪进度
   */
  startFakeProgress() {
    this.stopFakeProgress();
    const fakeProgressStep = () => {
      if (this.isCompleted) {
        return;
      }
      const remainingProgress = this.maxFakeProgress - this.currentProgress;
      if (remainingProgress > 0) {
        const increment = Math.max(0.1, remainingProgress * 0.02);
        const newProgress = Math.min(this.maxFakeProgress, this.currentProgress + increment);
        this.setProgress(newProgress);
        this.fakeProgressTimer = setTimeout(fakeProgressStep, 200);
      }
    };
    this.fakeProgressTimer = setTimeout(fakeProgressStep, 200);
  }
  /**
   * 停止伪进度
   */
  stopFakeProgress() {
    if (this.fakeProgressTimer) {
      clearTimeout(this.fakeProgressTimer);
      this.fakeProgressTimer = null;
    }
  }
  /**
   * 标记为完成状态
   */
  complete() {
    this.isCompleted = true;
    this.stopFakeProgress();
    this.setProgress(100);
    this.currentStep = "\u4E0A\u4F20\u5B8C\u6210\uFF0C\u6B63\u5728\u8BBE\u7F6E\u6743\u9650...";
    if (this.stepText) {
      this.stepText.textContent = this.currentStep;
    }
    setTimeout(() => {
      this.close();
    }, 800);
  }
  /**
   * 显示错误状态
   * @param errorMessage 错误信息
   */
  showError(errorMessage) {
    if (this.stepText) {
      this.stepText.textContent = `\u4E0A\u4F20\u5931\u8D25: ${errorMessage}`;
      this.stepText.style.color = "var(--text-error)";
    }
    if (this.progressBar) {
      this.progressBar.style.background = "var(--text-error)";
    }
    setTimeout(() => {
      this.close();
    }, 3e3);
  }
  onClose() {
    this.stopFakeProgress();
    const { contentEl } = this;
    contentEl.empty();
  }
};
var UserAgreementModal = class extends import_obsidian2.Modal {
  constructor(app, plugin) {
    super(app);
    this.plugin = plugin;
    this.component = new import_obsidian2.Component();
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("user-agreement-modal");
    contentEl.createEl("h2", { text: "ObShare \u7528\u6237\u534F\u8BAE" });
    const agreementContainer = contentEl.createDiv({ cls: "agreement-content" });
    agreementContainer.style.maxHeight = "500px";
    agreementContainer.style.overflowY = "auto";
    agreementContainer.style.padding = "15px";
    agreementContainer.style.border = "1px solid var(--background-modifier-border)";
    agreementContainer.style.borderRadius = "5px";
    agreementContainer.style.marginBottom = "20px";
    agreementContainer.style.width = "100%";
    agreementContainer.style.boxSizing = "border-box";
    const agreementText = `\u6B22\u8FCE\u4F7F\u7528ObShare\uFF08\u4EE5\u4E0B\u7B80\u79F0"\u672C\u63D2\u4EF6"\uFF09\u3002\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u4E4B\u524D\uFF0C\u8BF7\u60A8\u4ED4\u7EC6\u9605\u8BFB\u5E76\u7406\u89E3\u4EE5\u4E0B\u6761\u6B3E\u3002\u4F7F\u7528\u672C\u63D2\u4EF6\u5373\u89C6\u4E3A\u60A8\u5DF2\u540C\u610F\u5E76\u9075\u5B88\u672C\u534F\u8BAE\u3002

\u672C\u63D2\u4EF6\u662F\u4E00\u6B3E\u7528\u4E8E\u5C06\u60A8\u50A8\u5B58\u5728\u672C\u5730Obsidian\u7B14\u8BB0\u901A\u8FC7\u98DE\u4E66\uFF08\u4E0B\u79F0"\u76EE\u6807\u670D\u52A1"\uFF09\u5F00\u653E\u5E73\u53F0 api \u63A5\u53E3\u4E0A\u4F20\u5230\u60A8\u7684\u98DE\u4E66\u8D26\u53F7\u6240\u5C5E\u7684\u4E91\u7A7A\u95F4/\u4E91\u6587\u6863\uFF0C\u4ECE\u800C\u4F7F\u5F97\u60A8\u53EF\u4EE5\u66F4\u52A0\u65B9\u4FBF\u5206\u4EAB\u548C\u7BA1\u7406\u81EA\u5DF1\u7684\u7B14\u8BB0\u3002

\u5F53\u60A8\u4F7F\u7528\u63D2\u4EF6\u5C06\u7B14\u8BB0\u4E0A\u4F20\u81F3\u98DE\u4E66\u6587\u6863\u65F6\uFF1A\u8BE5\u6587\u6863\u7684\u5185\u5BB9\u7531\u60A8\u63D0\u4F9B\uFF1B\u6587\u6863\u7684\u53EF\u89C1\u6027\uFF08\u516C\u5F00/\u79C1\u6709\uFF09\u6743\u9650\u8BBE\u7F6E\u7531\u60A8\u63A7\u5236\uFF1B\u82E5\u5F00\u542F\u516C\u5F00\u94FE\u63A5\uFF0C\u4EFB\u4F55\u80FD\u8BBF\u95EE\u94FE\u63A5\u7684\u4EBA\u90FD\u53EF\u67E5\u770B\u3002

\u4E00\u65E6\u6570\u636E\u79BB\u5F00\u60A8\u7684\u8BBE\u5907\u8FDB\u5165\u76EE\u6807\u670D\u52A1\uFF08"\u98DE\u4E66"\u53CA\u5176\u4ED6\u53EF\u80FD\u7684\u670D\u52A1\u5546\uFF09\uFF0C\u540E\u7EED\u7684\u5B58\u50A8\u3001\u8BBF\u95EE\u3001\u5206\u4EAB\u3001\u7F13\u5B58\u3001\u65E5\u5FD7\u8BB0\u5F55\u7B49\u90FD\u9075\u5FAA\u5176\u81EA\u8EAB\u7684\u9690\u79C1\u653F\u7B56\u4E0E\u670D\u52A1\u6761\u6B3E\u3002\u60A8\u7406\u89E3\uFF0C\u5982\u98DE\u4E66\u53D1\u751F\u6570\u636E\u6CC4\u9732\u3001\u6587\u6863\u8BEF\u5220\u6216\u63A5\u53E3\u53D8\u66F4\u5BFC\u81F4\u4E0A\u4F20\u5931\u8D25\u7B49\u60C5\u51B5\uFF0C\u4E0E\u672C\u63D2\u4EF6\u65E0\u5173\u3002

## \u4E00\u3001\u9690\u79C1\u4E0E\u5B89\u5168

1. **\u6240\u6709\u6570\u636E\u5904\u7406\u5747\u5728\u672C\u5730\u5B8C\u6210\u3002** \u6211\u4EEC\u9AD8\u5EA6\u91CD\u89C6\u60A8\u7684\u9690\u79C1\uFF0C\u672C\u63D2\u4EF6\u7684\u6240\u6709\u529F\u80FD\u8FD0\u884C\u5747\u5728\u60A8\u7684\u8BBE\u5907\u672C\u5730\u8FDB\u884C\uFF0C\u4E0A\u4F20\u884C\u4E3A\u5C06\u53EA\u5728\u60A8\u7684\u8BBE\u5907\u4E0E\u76EE\u6807\u670D\u52A1\uFF08"\u98DE\u4E66"\u53CA\u5176\u4ED6\u53EF\u80FD\u7684\u670D\u52A1\u5546\uFF09\u4E4B\u95F4\u8FDB\u884C\uFF0C\u4E0D\u4F1A\u5C06\u4EFB\u4F55\u5185\u5BB9\u3001\u7B14\u8BB0\u3001\u914D\u7F6E\u6216\u5143\u6570\u636E\u4E0A\u4F20\u81F3\u4EFB\u4F55\u7B2C\u4E09\u65B9\u3002

2. **\u7EDD\u4E0D\u6536\u96C6\u3001\u5B58\u50A8\u6216\u4F20\u8F93\u7528\u6237\u6570\u636E\u3002** \u6211\u4EEC**\u4E0D\u6536\u96C6\u3001\u4E0D\u5206\u6790\u3001\u4E0D\u5171\u4EAB**\u4EFB\u4F55\u7528\u6237\u7684\u7B14\u8BB0\u5185\u5BB9\u3001\u6587\u4EF6\u8DEF\u5F84\u3001\u6807\u7B7E\u3001\u8BBE\u7F6E\u4FE1\u606F\u6216\u5176\u4ED6\u4E2A\u4EBA\u6570\u636E\u3002\u65E0\u8BBA\u4F55\u79CD\u60C5\u51B5\uFF0C\u60A8\u7684\u6570\u636E\u59CB\u7EC8\u5C5E\u4E8E\u60A8\u672C\u4EBA\u3002\u60A8\u7684\u76F8\u5173\u8BBE\u7F6E\u4FE1\u606F\u3001\u654F\u611F\u4EE4\u724C\u6216\u5176\u4ED6\u4F7F\u7528\u672C\u63D2\u4EF6\u65F6\u4EA7\u751F\u7684\u6570\u636E\uFF0C\u5C06\u50A8\u5B58\u5728\u60A8\u7684\u8BBE\u5907\u672C\u5730\uFF0C\u60A8\u53EF\u4EE5\u5728\u672C\u63D2\u4EF6\u6587\u4EF6\u5939 \`data.json\` \u4E2D\u968F\u65F6\u67E5\u770B\u3002

3. **\u65E0\u76D1\u63A7\u3001\u65E0\u8FFD\u8E2A\u3001\u65E0\u5E7F\u544A\u3002** \u672C\u63D2\u4EF6\u4E0D\u4F1A\u542F\u7528\u4EFB\u4F55\u5F62\u5F0F\u7684\u6570\u636E\u8FFD\u8E2A\u3001\u7528\u6237\u884C\u4E3A\u76D1\u63A7\u3001\u6027\u80FD\u7EDF\u8BA1\u6216\u5E7F\u544A\u6295\u653E\u673A\u5236\u3002

4. **\u900F\u660E\u4E0E\u53EF\u5BA1\u8BA1**\u3002\u672C\u63D2\u4EF6\u6E90\u4EE3\u7801\u5B8C\u5168\u5F00\u6E90\uFF0C\u60A8\u53EF\u4EE5\u81EA\u7531\u67E5\u770B\u3001\u5BA1\u67E5\u548C\u9A8C\u8BC1\u5176\u884C\u4E3A\u3002\u6211\u4EEC\u9F13\u52B1\u793E\u533A\u53C2\u4E0E\u4EE3\u7801\u5BA1\u8BA1\uFF0C\u5171\u540C\u7EF4\u62A4\u9690\u79C1\u5B89\u5168\u3002

## \u4E8C\u3001\u4E0A\u4F20\u884C\u4E3A\u8D23\u4EFB\u8BF4\u660E

1. **\u63D2\u4EF6\u672C\u8EAB\u4E0D\u4E3B\u52A8\u4E0A\u4F20\u6570\u636E**\u3002\u672C\u63D2\u4EF6\u4E0D\u4F1A\u81EA\u52A8\u6216\u9ED8\u8BA4\u5C06\u4EFB\u4F55\u5185\u5BB9\u4E0A\u4F20\u81F3\u4E92\u8054\u7F51\u3002\u82E5\u67D0\u529F\u80FD\u6D89\u53CA\u7F51\u7EDC\u8BF7\u6C42\uFF08\u5982\u4E0B\u8F7D\u6A21\u677F\u3001\u83B7\u53D6\u66F4\u65B0\u3001\u8BBF\u95EE\u516C\u5F00 API \u7B49\uFF09\uFF0C\u8BE5\u884C\u4E3A\u5FC5\u987B\u7531\u7528\u6237\u4E3B\u52A8\u89E6\u53D1\uFF0C\u6216\u8005\u5C06\u660E\u786E\u63D0\u793A\u7528\u6237\uFF0C\u5E76\u9700\u7528\u6237**\u4E3B\u52A8\u786E\u8BA4**\u540E\u65B9\u53EF\u6267\u884C\u3002

2. **\u7528\u6237\u81EA\u884C\u627F\u62C5\u4E0A\u4F20\u98CE\u9669**\u3002\u82E5\u60A8\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u65F6\u9009\u62E9\u901A\u8FC7\u5176\u529F\u80FD\u4E0A\u4F20\u6587\u4EF6\u3001\u540C\u6B65\u5230\u4E91\u670D\u52A1\u3001\u53D1\u9001\u81F3\u5916\u90E8\u63A5\u53E3\u7B49\u64CD\u4F5C\uFF0C**\u8BE5\u884C\u4E3A\u5B8C\u5168\u7531\u60A8\u81EA\u4E3B\u51B3\u5B9A**\u3002\u60A8\u5E94\u5145\u5206\u4E86\u89E3\u76EE\u6807\u670D\u52A1\uFF08"\u98DE\u4E66"\u53CA\u5176\u4ED6\u53EF\u80FD\u7684\u670D\u52A1\u5546\uFF09\u7684\u9690\u79C1\u653F\u7B56\u53CA\u6570\u636E\u5904\u7406\u65B9\u5F0F\uFF0C\u5E76\u81EA\u884C\u627F\u62C5\u7531\u6B64\u4EA7\u751F\u7684\u4EFB\u4F55\u98CE\u9669\u3002\u82E5\u60A8\u5F00\u542F\u4E92\u8054\u7F51\u516C\u5F00\u529F\u80FD\uFF0C\u4F60\u9700\u8981\u9075\u5B88\u76EE\u6807\u670D\u52A1\u7684\u7BA1\u7406\u89C4\u5B9A\uFF0C\u8BE5\u529F\u80FD\u5F00\u542F\u540E\uFF0C\u4E92\u8054\u7F51\u4E0A\u83B7\u5F97\u94FE\u63A5\u7684\u4EBA\u90FD\u80FD\u591F\u8BBF\u95EE\u8BE5\u6587\u6863\u3002\u60A8\u4F5C\u4E3A\u6587\u6863\u6240\u6709\u8005\uFF0C\u9700\u5BF9\u5176\u5408\u6CD5\u5408\u89C4\u6027\u8D1F\u8D23\uFF0C\u4E0E\u672C\u63D2\u4EF6\u65E0\u5173\u3002

3. **\u6211\u4EEC\u4E0D\u5BF9\u7B2C\u4E09\u65B9\u670D\u52A1\u8D1F\u8D23**\u3002\u4E00\u65E6\u6570\u636E\u79BB\u5F00\u60A8\u7684\u8BBE\u5907\uFF0C\u5176\u540E\u7EED\u5904\u7406\u4E0D\u518D\u53D7\u672C\u63D2\u4EF6\u63A7\u5236\u3002\u6211\u4EEC\u4E0D\u5BF9\u7B2C\u4E09\u65B9\u5E73\u53F0\u7684\u884C\u4E3A\u3001\u6570\u636E\u6CC4\u9732\u3001\u6EE5\u7528\u6216\u4E22\u5931\u627F\u62C5\u8D23\u4EFB\u3002

## \u4E09\u3001\u77E5\u8BC6\u4EA7\u6743\u4E0E\u8BB8\u53EF

1. **\u63D2\u4EF6\u8457\u4F5C\u6743\u5F52\u5C5E**\u3002\u672C\u63D2\u4EF6\u53CA\u5176\u6240\u6709\u6E90\u4EE3\u7801\u3001\u6587\u6863\u3001\u56FE\u6807\u3001\u754C\u9762\u8BBE\u8BA1\u7B49\u5185\u5BB9\uFF08\u4EE5\u4E0B\u7B80\u79F0"\u4F5C\u54C1"\uFF09\u7684\u8457\u4F5C\u6743\u53CA\u76F8\u5173\u77E5\u8BC6\u4EA7\u6743\u5747\u5F52\u539F\u4F5C\u8005\u53CA\u8D21\u732E\u8005\u6240\u6709\u3002\u672A\u7ECF\u4E66\u9762\u8BB8\u53EF\uFF0C\u4EFB\u4F55\u5355\u4F4D\u6216\u4E2A\u4EBA\u4E0D\u5F97\u4EE5\u590D\u5236\u3001\u4FEE\u6539\u3001\u5206\u53D1\u3001\u5546\u4E1A\u4F7F\u7528\u7B49\u65B9\u5F0F\u4F7F\u7528\u672C\u4F5C\u54C1\u3002

2. **\u7528\u6237\u5185\u5BB9\u6240\u6709\u6743**\u3002\u60A8\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u8FC7\u7A0B\u4E2D\u4E0A\u4F20\u81F3\u98DE\u4E66\u6216\u5176\u4ED6\u76EE\u6807\u670D\u52A1\u7684\u6240\u6709\u7B14\u8BB0\u5185\u5BB9\u3001\u6587\u6863\u3001\u56FE\u7247\u3001\u5143\u6570\u636E\u7B49\uFF08\u4EE5\u4E0B\u7B80\u79F0"\u7528\u6237\u5185\u5BB9"\uFF09\uFF0C\u5176\u77E5\u8BC6\u4EA7\u6743\u59CB\u7EC8\u5F52\u5C5E\u4E8E\u60A8\u672C\u4EBA\u3002\u672C\u63D2\u4EF6\u4E0D\u4E3B\u5F20\u5BF9\u4EFB\u4F55\u7528\u6237\u5185\u5BB9\u4EAB\u6709\u6743\u5229\u3002

## \u56DB\u3001\u8D23\u4EFB\u9650\u5236\u4E0E\u514D\u8D23\u6761\u6B3E

1. **\u65E0\u660E\u793A\u6216\u6697\u793A\u62C5\u4FDD**\u3002\u672C\u63D2\u4EF6\u6309"\u73B0\u72B6"\u548C"\u53EF\u7528"\u57FA\u7840\u63D0\u4F9B\uFF0C\u4F5C\u8005\u53CA\u7EF4\u62A4\u56E2\u961F**\u4E0D\u4F5C\u4EFB\u4F55\u660E\u793A\u6216\u6697\u793A\u7684\u4FDD\u8BC1**\uFF0C\u5305\u62EC\u4F46\u4E0D\u9650\u4E8E\uFF1A\u9002\u9500\u6027\u3001\u7279\u5B9A\u7528\u9014\u9002\u7528\u6027\u3001\u4E0D\u4FB5\u6743\u3001\u65E0\u9519\u8BEF\u6216\u4E2D\u65AD\u3001\u6301\u7EED\u53EF\u7528\u6027\u7B49\u3002\u4F7F\u7528\u672C\u63D2\u4EF6\u7684\u98CE\u9669\u7531\u60A8\u81EA\u884C\u627F\u62C5\u3002

2. **\u4E0D\u627F\u62C5\u95F4\u63A5\u635F\u5931**\u3002\u5728\u4EFB\u4F55\u60C5\u51B5\u4E0B\uFF0C\u65E0\u8BBA\u57FA\u4E8E\u5408\u540C\u3001\u4FB5\u6743\u3001\u4E25\u683C\u8D23\u4EFB\u6216\u5176\u4ED6\u6CD5\u5F8B\u7406\u8BBA\uFF0C\u4F5C\u8005\u53CA\u5173\u8054\u65B9\u5747\u4E0D\u5BF9\u56E0\u4F7F\u7528\u6216\u65E0\u6CD5\u4F7F\u7528\u672C\u63D2\u4EF6\u800C\u5BFC\u81F4\u7684**\u4EFB\u4F55\u95F4\u63A5\u3001\u9644\u5E26\u3001\u7279\u6B8A\u3001\u540E\u679C\u6027\u635F\u5BB3**\uFF08\u5305\u62EC\u4F46\u4E0D\u9650\u4E8E\u6570\u636E\u4E22\u5931\u3001\u4E1A\u52A1\u4E2D\u65AD\u3001\u5229\u6DA6\u635F\u5931\u3001\u4FE1\u606F\u6CC4\u9732\uFF09\u627F\u62C5\u8D23\u4EFB\u3002

3. **\u670D\u52A1\u4E2D\u65AD\u6216\u63A5\u53E3\u53D8\u66F4\u98CE\u9669**\u3002\u98DE\u4E66\u53CA\u5176\u4ED6\u76EE\u6807\u670D\u52A1\u5546\u53EF\u80FD\u968F\u65F6\u8C03\u6574\u5176 API \u63A5\u53E3\u89C4\u8303\u3001\u8BBF\u95EE\u7B56\u7565\u6216\u7EC8\u6B62\u670D\u52A1\u3002\u82E5\u56E0\u4E0A\u8FF0\u539F\u56E0\u5BFC\u81F4\u672C\u63D2\u4EF6\u529F\u80FD\u5931\u6548\u3001\u4E0A\u4F20\u5931\u8D25\u6216\u6570\u636E\u5F02\u5E38\uFF0C\u4F5C\u8005\u4E0D\u627F\u62C5\u4EFB\u4F55\u8D23\u4EFB\u3002\u5EFA\u8BAE\u60A8\u5B9A\u671F\u5907\u4EFD\u91CD\u8981\u6570\u636E\uFF0C\u5E76\u5173\u6CE8\u76EE\u6807\u5E73\u53F0\u516C\u544A\u3002

4. **\u7528\u6237\u884C\u4E3A\u5408\u89C4\u4E49\u52A1**\u3002\u60A8\u627F\u8BFA\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u4E0A\u4F20\u5185\u5BB9\u65F6\uFF0C\u9075\u5B88\u60A8\u6240\u5728\u5730\u533A\u76F8\u5173\u6CD5\u5F8B\u6CD5\u89C4\u5B9A\u3002\u7981\u6B62\u4E0A\u4F20\u542B\u6709\u8FDD\u6CD5\u4E0D\u826F\u4FE1\u606F\u3001\u4FB5\u72AF\u4ED6\u4EBA\u7248\u6743\u3001\u9690\u79C1\u6743\u6216\u5546\u4E1A\u79D8\u5BC6\u7684\u5185\u5BB9\u3002\u82E5\u56E0\u4E0A\u4F20\u5185\u5BB9\u5F15\u53D1\u7EA0\u7EB7\u6216\u6CD5\u5F8B\u8D23\u4EFB\uFF0C\u7531\u60A8\u81EA\u884C\u627F\u62C5\u5168\u90E8\u540E\u679C\u3002

## \u4E94\u3001\u534F\u8BAE\u4FEE\u6539\u4E0E\u7EC8\u6B62

1. **\u534F\u8BAE\u66F4\u65B0\u901A\u77E5**\u3002\u4F5C\u8005\u4FDD\u7559\u968F\u65F6\u4FEE\u8BA2\u672C\u534F\u8BAE\u7684\u6743\u5229\u3002\u91CD\u5927\u53D8\u66F4\u5C06\u901A\u8FC7 Obsidian \u63D2\u4EF6\u5E02\u573A\u516C\u544A\u3001GitHub \u53D1\u5E03\u8BF4\u660E\u7B49\u65B9\u5F0F\u901A\u77E5\u7528\u6237\u3002\u7EE7\u7EED\u4F7F\u7528\u672C\u63D2\u4EF6\u5373\u89C6\u4E3A\u63A5\u53D7\u6700\u65B0\u7248\u672C\u534F\u8BAE\u3002

2. **\u7528\u6237\u81EA\u4E3B\u9000\u51FA\u673A\u5236**\u3002\u60A8\u53EF\u968F\u65F6\u5378\u8F7D\u672C\u63D2\u4EF6\u6216\u5220\u9664\u672C\u5730\u914D\u7F6E\u6587\u4EF6\uFF08\u5982 \`data.json\`\uFF09\u4EE5\u7EC8\u6B62\u4F7F\u7528\u3002\u4E00\u65E6\u5378\u8F7D\uFF0C\u6240\u6709\u672C\u5730\u7F13\u5B58\u6570\u636E\u5C06\u88AB\u6E05\u9664\uFF0C\u4F46\u60A8\u5728\u98DE\u4E66\u7B49\u5916\u90E8\u5E73\u53F0\u5DF2\u7ECF\u4E0A\u4F20\u7684\u5185\u5BB9\u4E0D\u4F1A\u56E0\u6B64\u5220\u9664\uFF0C\u4ECD\u9700\u60A8\u81EA\u884C\u5904\u7406\uFF0C\u60A8\u4ECD\u9700\u5BF9\u4E0A\u4F20\u81F3\u98DE\u4E66\u7B49\u5916\u90E8\u5E73\u53F0\u7684\u5185\u5BB9\u8D1F\u8D23\u3002

3. **\u63D2\u4EF6\u7EC8\u6B62\u4F7F\u7528**\u3002\u82E5\u53D1\u73B0\u672C\u63D2\u4EF6\u5B58\u5728\u4E25\u91CD\u5B89\u5168\u6F0F\u6D1E\u3001\u6076\u610F\u884C\u4E3A\u6216\u8FDD\u53CD\u5F00\u6E90\u539F\u5219\u7684\u60C5\u51B5\uFF0C\u4F5C\u8005\u6709\u6743\u7ACB\u5373\u505C\u6B62\u7EF4\u62A4\u6216\u53D1\u5E03\u7EC8\u6B62\u7248\u672C\u3002\u5C4A\u65F6\u5EFA\u8BAE\u7528\u6237\u5C3D\u5FEB\u8FC1\u79FB\u6570\u636E\u5E76\u505C\u6B62\u4F7F\u7528\u3002`;
    import_obsidian2.MarkdownRenderer.renderMarkdown(agreementText, agreementContainer, "", this.component);
    const buttonContainer = contentEl.createDiv({ cls: "agreement-buttons" });
    buttonContainer.style.display = "flex";
    buttonContainer.style.justifyContent = "flex-end";
    buttonContainer.style.gap = "10px";
    const rejectButton = buttonContainer.createEl("button", {
      text: "\u62D2\u7EDD"
    });
    rejectButton.onclick = () => {
      this.close();
      new import_obsidian2.Notice("\u60A8\u5DF2\u62D2\u7EDD\u7528\u6237\u534F\u8BAE\uFF0C\u63D2\u4EF6\u529F\u80FD\u5C06\u4E0D\u53EF\u7528\u3002", 5e3);
    };
    const agreeButton = buttonContainer.createEl("button", {
      text: "\u540C\u610F\u5E76\u7EE7\u7EED",
      cls: "mod-cta"
    });
    agreeButton.onclick = async () => {
      this.plugin.settings.agreedToTerms = true;
      await this.plugin.saveSettings();
      this.plugin.completeInitialization();
      this.close();
      new import_obsidian2.Notice("\u6B22\u8FCE\u4F7F\u7528 ObShare\uFF01", 3e3);
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
